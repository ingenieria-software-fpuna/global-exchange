{% extends "base.html" %}

{% block title %}{{ titulo }} - Global Exchange{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">{{ titulo }}</h1>
                    <p class="text-muted mb-0">Información detallada del tauser y su stock</p>
                </div>
                <div>
                    <a href="{% url 'tauser:tauser_update' tauser.pk %}" class="btn btn-primary me-2">
                        <i class="fas fa-edit me-2"></i>Editar Tauser
                    </a>
                    <a href="{% url 'tauser:tauser_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Listado
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Tauser -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-store me-2"></i>Información del Tauser
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Nombre</h6>
                            <p class="mb-0 fw-bold">{{ tauser.nombre }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Dirección</h6>
                            <p class="mb-0">{{ tauser.direccion }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Horario de Atención</h6>
                            <p class="mb-0">{{ tauser.horario_atencion }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Estado</h6>
                            {% if tauser.es_activo %}
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check me-1"></i>Activo
                            </span>
                            {% else %}
                            <span class="badge bg-secondary fs-6">
                                <i class="fas fa-pause me-1"></i>Inactivo
                            </span>
                            {% endif %}
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Fecha de Instalación</h6>
                            <p class="mb-0">{{ tauser.fecha_instalacion|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Estadísticas de Stock
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-1">{{ monedas_con_stock|length }}</h3>
                                <p class="text-muted mb-0">Monedas con Stock</p>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h3>
                                <p class="text-muted mb-0">Stocks Activos</p>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.esta_bajo_stock %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h3>
                                <p class="text-muted mb-0">Bajo Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock del Tauser -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-warehouse me-2"></i>Stock de Monedas - Monedas con Stock
                    </h5>
                    <div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" id="view-list-btn">
                                <i class="fas fa-list me-1"></i>Lista
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="view-table-btn">
                                <i class="fas fa-table me-1"></i>Tabla
                            </button>
                        </div>
                        {% if can_create_stock %}
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#cargarStockModal">
                            <i class="fas fa-plus me-1"></i>Cargar Billetes
                        </button>
                        {% endif %}
                        {% if perms.tauser.view_historial_stock %}
                        <a href="{% url 'tauser:historial_stock' tauser.pk %}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-history me-1"></i>Historial
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Lista Detallada de Monedas -->
                    <div class="row mb-4" id="list-view">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-list me-2"></i>Monedas con Stock ({{ monedas_con_stock|length }} monedas):
                            </h6>
                            <div class="row">
                                {% for item in monedas_con_stock %}
                                <div class="col-lg-6 mb-3">
                                    <div class="card border">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-info me-2 fs-6">{{ item.moneda.codigo }}</span>
                                                    <div>
                                                        <h6 class="mb-1 fw-bold">{{ item.moneda.nombre }}</h6>
                                                        <small class="text-muted">{{ item.moneda.simbolo }} • {{ item.moneda.decimales }} decimales</small>
                                                    </div>
                                                </div>
                                                {% if item.esta_bajo_stock %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Bajo Stock
                                                </span>
                                                {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>OK
                                                </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Cantidad Actual:</small>
                                                    <strong class="text-primary">
                                                        {{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }}
                                                    </strong>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Última actualización: {{ item.stock.fecha_actualizacion|date:"d/m/Y H:i" }}
                                                </small>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <div class="btn-group w-100" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                                            data-bs-toggle="modal" data-bs-target="#cargarStockModal"
                                                            onclick="seleccionarMoneda('{{ item.moneda.pk }}')" title="Cargar más stock">
                                                        <i class="fas fa-plus me-1"></i>Cargar Más
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" id="table-view" style="display: none;">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Moneda</th>
                                    <th>Cantidad en Stock</th>
                                    <th>Estado</th>
                                    <th>Alerta</th>
                                    <th>Última Actualización</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in monedas_con_stock %}
                                <tr class="{% if not item.tiene_stock %}table-light{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">{{ item.moneda.codigo }}</span>
                                            <div>
                                                <strong>{{ item.moneda.nombre }}</strong>
                                                <br>
                                                <small class="text-muted">{{ item.moneda.simbolo }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold">{{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }}</span>
                                    </td>
                                    <td>
                                    </td>
                                    <td>
                                        {% if item.es_activo %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.esta_bajo_stock %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Bajo Stock
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>OK
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ item.stock.fecha_actualizacion|date:"d/m/Y H:i" }}</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                data-bs-toggle="modal" data-bs-target="#cargarStockModal"
                                                onclick="seleccionarMoneda('{{ item.moneda.pk }}')" title="Cargar más stock">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Resumen de estadísticas -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-primary mb-1">{{ monedas_con_stock|length }}</h4>
                                <p class="text-muted mb-0">Monedas con Stock</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-success mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Stocks Activos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-warning mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if not item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Stocks Inactivos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-danger mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.esta_bajo_stock %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Bajo Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cargar Stock -->
{% if can_create_stock %}
<div class="modal fade" id="cargarStockModal" tabindex="-1" aria-labelledby="cargarStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cargarStockModalLabel">
                    <i class="fas fa-plus me-2"></i>Cargar Stock de Billetes - {{ tauser.nombre }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cargarStockForm" method="post" action="{% url 'tauser:cargar_stock' tauser.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="moneda_select" class="form-label">Moneda <span class="text-danger">*</span></label>
                            <select class="form-select" id="moneda_select" name="moneda" required>
                                <option value="">Seleccionar moneda...</option>
                                {% for item in todas_las_monedas %}
                                <option value="{{ item.moneda.pk }}" 
                                        data-symbol="{{ item.moneda.simbolo }}"
                                        data-decimales="{{ item.moneda.decimales }}"
                                        data-tiene-stock="{{ item.tiene_stock|yesno:'true,false' }}"
                                        data-cantidad-actual="{{ item.cantidad|default:0 }}">
                                    {{ item.moneda.codigo }} - {{ item.moneda.nombre }}
                                    {% if item.tiene_stock %}
                                        (Actual: {{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }})
                                    {% else %}
                                        (Sin stock)
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Información de la moneda seleccionada -->
                    <div id="info_moneda" class="alert alert-info" style="display: none;">
                        <h6 class="alert-heading">Información de la Moneda</h6>
                        <div id="detalles_moneda"></div>
                    </div>
                    
                    <!-- Denominaciones de la moneda seleccionada -->
                    <div id="denominaciones_container" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-money-bill me-2"></i>Billetes Disponibles
                        </h6>
                        <div class="row" id="denominaciones_list">
                            <!-- Las denominaciones se cargarán dinámicamente aquí -->
                        </div>
                    </div>
                    
                    <!-- Resumen de la operación -->
                    <div id="resumen_operacion" class="alert alert-success" style="display: none;">
                        <h6 class="alert-heading">Resumen de la Operación</h6>
                        <div id="detalles_operacion"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="submit_btn" disabled>
                        <i class="fas fa-save me-2"></i>Cargar Billetes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listViewBtn = document.getElementById('view-list-btn');
    const tableViewBtn = document.getElementById('view-table-btn');
    const listView = document.getElementById('list-view');
    const tableView = document.getElementById('table-view');
    
    // Función para mostrar vista de lista
    function showListView() {
        listView.style.display = 'block';
        tableView.style.display = 'none';
        listViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
    }
    
    // Función para mostrar vista de tabla
    function showTableView() {
        listView.style.display = 'none';
        tableView.style.display = 'block';
        listViewBtn.classList.remove('active');
        tableViewBtn.classList.add('active');
    }
    
    // Event listeners
    listViewBtn.addEventListener('click', showListView);
    tableViewBtn.addEventListener('click', showTableView);
    
    // Funcionalidad del modal de cargar stock por denominaciones
    const monedaSelect = document.getElementById('moneda_select');
    const simboloMonedaMin = document.getElementById('simbolo_moneda_min');
    const infoMoneda = document.getElementById('info_moneda');
    const detallesMoneda = document.getElementById('detalles_moneda');
    const denominacionesContainer = document.getElementById('denominaciones_container');
    const denominacionesList = document.getElementById('denominaciones_list');
    const resumenOperacion = document.getElementById('resumen_operacion');
    const detallesOperacion = document.getElementById('detalles_operacion');
    const submitBtn = document.getElementById('submit_btn');
    
    // Cache de denominaciones por moneda
    const denominacionesCache = {};
    
    // Variable para almacenar el HTML base de la información de moneda (sin stock por denominación)
    let infoMonedaBaseHTML = '';
    
    if (monedaSelect) {
        monedaSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const symbol = selectedOption.getAttribute('data-symbol') || '-';
            const decimales = selectedOption.getAttribute('data-decimales') || '2';
            const tieneStock = selectedOption.getAttribute('data-tiene-stock') === 'true';
            const cantidadActualStr = selectedOption.getAttribute('data-cantidad-actual') || '0';
            const cantidadActual = parseFloat(cantidadActualStr);
            
            if (this.value) {
                // Actualizar símbolo
                if (simboloMonedaMin) simboloMonedaMin.textContent = symbol;
                
                // Mostrar información de la moneda
                if (infoMoneda && detallesMoneda) {
                    let info = `<strong>Moneda:</strong> ${selectedOption.textContent}<br>`;
                    info += `<strong>Símbolo:</strong> ${symbol}<br>`;
                    info += `<strong>Decimales:</strong> ${decimales}<br>`;
                    // Formatear cantidad manteniendo los decimales originales
                    const cantidadFormateada = cantidadActualStr.replace(',', '.');
                    info += `<strong>Stock actual:</strong> ${symbol}${cantidadFormateada}`;
                    
                    // Guardar el HTML base (sin stock por denominación)
                    infoMonedaBaseHTML = info;
                    detallesMoneda.innerHTML = info;
                    infoMoneda.style.display = 'block';
                    // El stock por denominación se agregará después cuando se carguen las denominaciones
                }
                
                
                // Cargar denominaciones
                cargarDenominaciones(this.value, symbol, decimales);
            } else {
                // Limpiar y deshabilitar
                if (simboloMonedaMin) simboloMonedaMin.textContent = '-';
                if (infoMoneda) infoMoneda.style.display = 'none';
                if (denominacionesContainer) denominacionesContainer.style.display = 'none';
                if (resumenOperacion) resumenOperacion.style.display = 'none';
                if (submitBtn) submitBtn.disabled = true;
            }
        });
    }
    
    // Función para cargar denominaciones
    function cargarDenominaciones(monedaId, symbol, decimales) {
        const tauserId = {{ tauser.pk }};
        const cacheKey = `${monedaId}_${tauserId}`;
        
        if (denominacionesCache[cacheKey]) {
            mostrarDenominaciones(denominacionesCache[cacheKey], symbol, decimales);
            // Actualizar información de moneda con stock disponible
            actualizarInfoMonedaConStock(denominacionesCache[cacheKey], symbol);
            return;
        }
        
        // Hacer petición AJAX para obtener denominaciones con stock disponible
        fetch(`/tauser/denominaciones/${monedaId}/?tauser_id=${tauserId}`)
            .then(response => response.json())
            .then(data => {
                denominacionesCache[cacheKey] = data.denominaciones;
                mostrarDenominaciones(data.denominaciones, symbol, decimales);
                // Actualizar información de moneda con stock disponible
                actualizarInfoMonedaConStock(data.denominaciones, symbol);
            })
            .catch(error => {
                console.error('Error al cargar denominaciones:', error);
                if (denominacionesContainer) denominacionesContainer.style.display = 'none';
            });
    }
    
    // Función para actualizar la información de moneda con stock disponible por denominación
    function actualizarInfoMonedaConStock(denominaciones, symbol) {
        if (!detallesMoneda || !infoMonedaBaseHTML) return;
        
        // Restaurar el HTML base
        detallesMoneda.innerHTML = infoMonedaBaseHTML;
        
        // Filtrar solo las denominaciones que tienen stock disponible
        const denominacionesConStock = denominaciones.filter(d => d.stock_disponible > 0);
        
        if (denominacionesConStock.length > 0) {
            let stockInfo = '<hr class="my-2"><strong>Billetes disponibles por denominación:</strong><ul class="mb-0 mt-2">';
            denominacionesConStock.forEach(denominacion => {
                stockInfo += `<li>${denominacion.mostrar_denominacion}: <strong>${denominacion.stock_disponible}</strong> billetes</li>`;
            });
            stockInfo += '</ul>';
            
            // Agregar al contenido base
            detallesMoneda.innerHTML += stockInfo;
        }
    }
    
    // Función para mostrar denominaciones
    function mostrarDenominaciones(denominaciones, symbol, decimales) {
        if (!denominacionesList || !denominacionesContainer) return;
        
        denominacionesList.innerHTML = '';
        
        if (denominaciones.length === 0) {
            denominacionesList.innerHTML = '<div class="col-12"><div class="alert alert-warning">No hay billetes configurados para esta moneda.</div></div>';
            denominacionesContainer.style.display = 'block';
            return;
        }
        
        denominaciones.forEach(denominacion => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            const card = document.createElement('div');
            card.className = 'card h-100';
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            const tipoIcon = denominacion.tipo === 'BILLETE' ? 'fas fa-money-bill' : 'fas fa-coins';
            const tipoColor = denominacion.tipo === 'BILLETE' ? 'text-success' : 'text-warning';
            
            cardBody.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="${tipoIcon} ${tipoColor} me-2"></i>
                    <h6 class="card-title mb-0">${denominacion.mostrar_denominacion}</h6>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label small">Cantidad</label>
                        <input type="number" 
                               class="form-control denominacion-cantidad" 
                               name="cantidad_${denominacion.id}"
                               data-denominacion-id="${denominacion.id}"
                               data-valor="${denominacion.valor}"
                               min="0" 
                               placeholder="0">
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted denominacion-total" data-denominacion-id="${denominacion.id}">
                        Total: ${symbol}0.00
                    </small>
                </div>
            `;
            
            card.appendChild(cardBody);
            col.appendChild(card);
            denominacionesList.appendChild(col);
        });
        
        denominacionesContainer.style.display = 'block';
        
        // Agregar event listeners a los campos de denominaciones
        agregarEventListenersDenominaciones(symbol, decimales);
    }
    
    // Función para agregar event listeners a las denominaciones
    function agregarEventListenersDenominaciones(symbol, decimales) {
        const cantidadInputs = document.querySelectorAll('.denominacion-cantidad');
        cantidadInputs.forEach(input => {
            input.addEventListener('input', () => actualizarResumenDenominaciones(symbol, decimales));
        });
    }
    
    // Función para actualizar resumen de denominaciones
    function actualizarResumenDenominaciones(symbol, decimales) {
        if (!resumenOperacion || !detallesOperacion) return;
        
        const cantidadInputs = document.querySelectorAll('.denominacion-cantidad');
        let totalGeneral = 0;
        let resumen = '<strong>Detalle por denominación:</strong><br>';
        let tieneCantidades = false;
        
        cantidadInputs.forEach(input => {
            const cantidad = parseInt(input.value) || 0;
            const denominacionId = input.getAttribute('data-denominacion-id');
            const valor = parseFloat(input.getAttribute('data-valor'));
            
            if (cantidad > 0) {
                const totalDenominacion = cantidad * valor;
                totalGeneral += totalDenominacion;
                resumen += `• ${cantidad} unidades × ${symbol}${valor.toFixed(decimales)} = ${symbol}${totalDenominacion.toFixed(decimales)}<br>`;
                tieneCantidades = true;
            }
            
            // Actualizar total individual
            const totalElement = document.querySelector(`[data-denominacion-id="${denominacionId}"].denominacion-total`);
            if (totalElement) {
                const totalIndividual = cantidad * valor;
                totalElement.textContent = `Total: ${symbol}${totalIndividual.toFixed(decimales)}`;
            }
        });
        
        if (tieneCantidades) {
            resumen += `<br><strong>Total general: ${symbol}${totalGeneral.toFixed(decimales)}</strong>`;
            detallesOperacion.innerHTML = resumen;
            resumenOperacion.style.display = 'block';
            if (submitBtn) submitBtn.disabled = false;
        } else {
            resumenOperacion.style.display = 'none';
            if (submitBtn) submitBtn.disabled = true;
        }
    }
    
    // Función global para seleccionar moneda en el modal
    window.seleccionarMoneda = function(monedaId) {
        const monedaSelect = document.getElementById('moneda_select');
        if (monedaSelect) {
            monedaSelect.value = monedaId;
            monedaSelect.dispatchEvent(new Event('change'));
        }
    };
});
</script>
{% endblock %}
