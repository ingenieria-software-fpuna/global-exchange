{% extends "base.html" %}

{% block title %}{{ titulo }} - Global Exchange{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">{{ titulo }}</h1>
                    <p class="text-muted mb-0">Información detallada del tauser y su stock</p>
                </div>
                <div>
                    <a href="{% url 'tauser:tauser_update' tauser.pk %}" class="btn btn-primary me-2">
                        <i class="fas fa-edit me-2"></i>Editar Tauser
                    </a>
                    <a href="{% url 'tauser:tauser_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver al Listado
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Tauser -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-store me-2"></i>Información del Tauser
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Nombre</h6>
                            <p class="mb-0 fw-bold">{{ tauser.nombre }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Dirección</h6>
                            <p class="mb-0">{{ tauser.direccion }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Horario de Atención</h6>
                            <p class="mb-0">{{ tauser.horario_atencion }}</p>
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Estado</h6>
                            {% if tauser.es_activo %}
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check me-1"></i>Activo
                            </span>
                            {% else %}
                            <span class="badge bg-secondary fs-6">
                                <i class="fas fa-pause me-1"></i>Inactivo
                            </span>
                            {% endif %}
                        </div>
                        <div class="col-12 mb-3">
                            <h6 class="text-muted mb-2">Fecha de Instalación</h6>
                            <p class="mb-0">{{ tauser.fecha_instalacion|date:"d/m/Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas Rápidas -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Estadísticas de Stock
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-1">{{ monedas_con_stock|length }}</h3>
                                <p class="text-muted mb-0">Monedas con Stock</p>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h3>
                                <p class="text-muted mb-0">Stocks Activos</p>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.esta_bajo_stock %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h3>
                                <p class="text-muted mb-0">Bajo Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock del Tauser -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-warehouse me-2"></i>Stock de Monedas - Monedas con Stock
                    </h5>
                    <div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" id="view-list-btn">
                                <i class="fas fa-list me-1"></i>Lista
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="view-table-btn">
                                <i class="fas fa-table me-1"></i>Tabla
                            </button>
                        </div>
                        {% if can_create_stock %}
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#cargarStockModal">
                            <i class="fas fa-plus me-1"></i>Cargar Stock
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Lista Detallada de Monedas -->
                    <div class="row mb-4" id="list-view">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-list me-2"></i>Monedas con Stock ({{ monedas_con_stock|length }} monedas):
                            </h6>
                            <div class="row">
                                {% for item in monedas_con_stock %}
                                <div class="col-lg-6 mb-3">
                                    <div class="card border">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-info me-2 fs-6">{{ item.moneda.codigo }}</span>
                                                    <div>
                                                        <h6 class="mb-1 fw-bold">{{ item.moneda.nombre }}</h6>
                                                        <small class="text-muted">{{ item.moneda.simbolo }} • {{ item.moneda.decimales }} decimales</small>
                                                    </div>
                                                </div>
                                                {% if item.esta_bajo_stock %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>Bajo Stock
                                                </span>
                                                {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>OK
                                                </span>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Cantidad Actual:</small>
                                                    <strong class="text-primary">
                                                        {{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }}
                                                    </strong>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Cantidad Mínima:</small>
                                                    <span class="text-muted">
                                                        {{ item.moneda.simbolo }}{{ item.cantidad_minima|floatformat:item.moneda.decimales }}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Última actualización: {{ item.stock.fecha_actualizacion|date:"d/m/Y H:i" }}
                                                </small>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <div class="btn-group w-100" role="group">
                                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                                            data-bs-toggle="modal" data-bs-target="#cargarStockModal"
                                                            onclick="seleccionarMoneda('{{ item.moneda.pk }}')" title="Cargar más stock">
                                                        <i class="fas fa-plus me-1"></i>Cargar Más
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive" id="table-view" style="display: none;">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Moneda</th>
                                    <th>Cantidad en Stock</th>
                                    <th>Cantidad Mínima</th>
                                    <th>Estado</th>
                                    <th>Alerta</th>
                                    <th>Última Actualización</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in monedas_con_stock %}
                                <tr class="{% if not item.tiene_stock %}table-light{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">{{ item.moneda.codigo }}</span>
                                            <div>
                                                <strong>{{ item.moneda.nombre }}</strong>
                                                <br>
                                                <small class="text-muted">{{ item.moneda.simbolo }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="fw-bold">{{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }}</span>
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ item.moneda.simbolo }}{{ item.cantidad_minima|floatformat:item.moneda.decimales }}</span>
                                    </td>
                                    <td>
                                        {% if item.es_activo %}
                                        <span class="badge bg-success">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.esta_bajo_stock %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Bajo Stock
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>OK
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ item.stock.fecha_actualizacion|date:"d/m/Y H:i" }}</small>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-success" 
                                                data-bs-toggle="modal" data-bs-target="#cargarStockModal"
                                                onclick="seleccionarMoneda('{{ item.moneda.pk }}')" title="Cargar más stock">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Resumen de estadísticas -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-primary mb-1">{{ monedas_con_stock|length }}</h4>
                                <p class="text-muted mb-0">Monedas con Stock</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-success mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Stocks Activos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-warning mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if not item.es_activo %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Stocks Inactivos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 border rounded bg-light">
                                <h4 class="text-danger mb-1">
                                    {% for item in monedas_con_stock %}
                                        {% if item.esta_bajo_stock %}{{ forloop.counter0|add:1 }}{% endif %}
                                    {% empty %}
                                        0
                                    {% endfor %}
                                </h4>
                                <p class="text-muted mb-0">Bajo Stock</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cargar Stock -->
{% if can_create_stock %}
<div class="modal fade" id="cargarStockModal" tabindex="-1" aria-labelledby="cargarStockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cargarStockModalLabel">
                    <i class="fas fa-plus me-2"></i>Cargar Stock - {{ tauser.nombre }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cargarStockForm" method="post" action="{% url 'tauser:cargar_stock' tauser.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="moneda_select" class="form-label">Moneda <span class="text-danger">*</span></label>
                            <select class="form-select" id="moneda_select" name="moneda" required>
                                <option value="">Seleccionar moneda...</option>
                                {% for item in monedas_con_stock %}
                                <option value="{{ item.moneda.pk }}" 
                                        data-symbol="{{ item.moneda.simbolo }}"
                                        data-decimales="{{ item.moneda.decimales }}"
                                        data-tiene-stock="{{ item.tiene_stock|yesno:'true,false' }}"
                                        data-cantidad-actual="{{ item.cantidad|default:0 }}">
                                    {{ item.moneda.codigo }} - {{ item.moneda.nombre }}
                                    {% if item.tiene_stock %}
                                        (Actual: {{ item.moneda.simbolo }}{{ item.cantidad|floatformat:item.moneda.decimales }})
                                    {% else %}
                                        (Sin stock)
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cantidad_agregar" class="form-label">Cantidad a Agregar <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="cantidad_agregar" name="cantidad_agregar" 
                                       step="0.01" min="0" placeholder="0.00" required>
                                <span class="input-group-text" id="simbolo_moneda">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cantidad_minima" class="form-label">Cantidad Mínima (Opcional)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="cantidad_minima" name="cantidad_minima" 
                                       step="0.01" min="0" placeholder="0.00">
                                <span class="input-group-text" id="simbolo_moneda_min">-</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="es_activo" name="es_activo" checked>
                                <label class="form-check-label" for="es_activo">
                                    Activar stock inmediatamente
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de la moneda seleccionada -->
                    <div id="info_moneda" class="alert alert-info" style="display: none;">
                        <h6 class="alert-heading">Información de la Moneda</h6>
                        <div id="detalles_moneda"></div>
                    </div>
                    
                    <!-- Resumen de la operación -->
                    <div id="resumen_operacion" class="alert alert-success" style="display: none;">
                        <h6 class="alert-heading">Resumen de la Operación</h6>
                        <div id="detalles_operacion"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Cargar Stock
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const listViewBtn = document.getElementById('view-list-btn');
    const tableViewBtn = document.getElementById('view-table-btn');
    const listView = document.getElementById('list-view');
    const tableView = document.getElementById('table-view');
    
    // Función para mostrar vista de lista
    function showListView() {
        listView.style.display = 'block';
        tableView.style.display = 'none';
        listViewBtn.classList.add('active');
        tableViewBtn.classList.remove('active');
    }
    
    // Función para mostrar vista de tabla
    function showTableView() {
        listView.style.display = 'none';
        tableView.style.display = 'block';
        listViewBtn.classList.remove('active');
        tableViewBtn.classList.add('active');
    }
    
    // Event listeners
    listViewBtn.addEventListener('click', showListView);
    tableViewBtn.addEventListener('click', showTableView);
    
    // Funcionalidad del modal de cargar stock
    const monedaSelect = document.getElementById('moneda_select');
    const cantidadAgregar = document.getElementById('cantidad_agregar');
    const cantidadMinima = document.getElementById('cantidad_minima');
    const simboloMoneda = document.getElementById('simbolo_moneda');
    const simboloMonedaMin = document.getElementById('simbolo_moneda_min');
    const infoMoneda = document.getElementById('info_moneda');
    const resumenOperacion = document.getElementById('resumen_operacion');
    const detallesMoneda = document.getElementById('detalles_moneda');
    const detallesOperacion = document.getElementById('detalles_operacion');
    
    if (monedaSelect) {
        monedaSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const symbol = selectedOption.getAttribute('data-symbol') || '-';
            const decimales = selectedOption.getAttribute('data-decimales') || '2';
            const tieneStock = selectedOption.getAttribute('data-tiene-stock') === 'true';
            const cantidadActual = parseFloat(selectedOption.getAttribute('data-cantidad-actual')) || 0;
            
            // Actualizar símbolos
            simboloMoneda.textContent = symbol;
            simboloMonedaMin.textContent = symbol;
            
            // Configurar step según decimales
            cantidadAgregar.step = `0.${'0'.repeat(parseInt(decimales) - 1)}1`;
            cantidadMinima.step = `0.${'0'.repeat(parseInt(decimales) - 1)}1`;
            
            // Mostrar información de la moneda
            if (this.value) {
                let info = `<strong>${selectedOption.textContent.split(' - ')[1]}</strong><br>`;
                info += `Símbolo: ${symbol}<br>`;
                info += `Decimales: ${decimales}<br>`;
                if (tieneStock) {
                    info += `Stock actual: ${symbol}${cantidadActual.toFixed(parseInt(decimales))}`;
                } else {
                    info += `Estado: Sin stock registrado`;
                }
                detallesMoneda.innerHTML = info;
                infoMoneda.style.display = 'block';
            } else {
                infoMoneda.style.display = 'none';
            }
        });
        
        // Actualizar resumen cuando cambie la cantidad
        cantidadAgregar.addEventListener('input', updateResumen);
        cantidadMinima.addEventListener('input', updateResumen);
        
        function updateResumen() {
            const selectedOption = monedaSelect.options[monedaSelect.selectedIndex];
            if (monedaSelect.value && cantidadAgregar.value) {
                const symbol = selectedOption.getAttribute('data-symbol') || '-';
                const decimales = parseInt(selectedOption.getAttribute('data-decimales')) || 2;
                const cantidadActual = parseFloat(selectedOption.getAttribute('data-cantidad-actual')) || 0;
                const cantidadNueva = parseFloat(cantidadAgregar.value) || 0;
                const cantidadMin = parseFloat(cantidadMinima.value) || 0;
                
                let resumen = `Moneda: ${selectedOption.textContent.split(' - ')[1]}<br>`;
                resumen += `Cantidad actual: ${symbol}${cantidadActual.toFixed(decimales)}<br>`;
                resumen += `Cantidad a agregar: ${symbol}${cantidadNueva.toFixed(decimales)}<br>`;
                resumen += `Nueva cantidad: ${symbol}${(cantidadActual + cantidadNueva).toFixed(decimales)}<br>`;
                if (cantidadMin > 0) {
                    resumen += `Cantidad mínima: ${symbol}${cantidadMin.toFixed(decimales)}<br>`;
                }
                
                detallesOperacion.innerHTML = resumen;
                resumenOperacion.style.display = 'block';
            } else {
                resumenOperacion.style.display = 'none';
            }
        }
    }
    
    // Función global para seleccionar moneda en el modal
    window.seleccionarMoneda = function(monedaId) {
        const monedaSelect = document.getElementById('moneda_select');
        if (monedaSelect) {
            monedaSelect.value = monedaId;
            monedaSelect.dispatchEvent(new Event('change'));
        }
    };
});
</script>
{% endblock %}
