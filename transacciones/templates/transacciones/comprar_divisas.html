{% extends "base.html" %}
{% load moneda_extras %}

{% block title %}Comprar Divisas{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fas fa-shopping-cart me-2 text-primary"></i>
          {{ titulo }}
        </h1>
        <a href="{% url 'tasa_cambio:dashboard' %}" class="btn btn-outline-secondary">
          <i class="fas fa-chart-line me-1"></i>
          Ir al Simulador
        </a>
      </div>

      <!-- Formulario de Compra -->
      <div class="card shadow-sm">
        <div class="card-body">

          <!-- Información -->
          <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Usted está comprando divisas extranjeras y pagará usando uno de nuestros métodos de cobro disponibles.
          </div>


          <form id="formCompra">
            {% csrf_token %}
            
            <!-- Selector de Cliente -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label for="cliente" class="form-label">
                  <i class="fas fa-user me-1"></i>
                  Cliente <span class="text-danger">*</span>
                </label>
                <select id="cliente" name="cliente_id" class="form-select" required>
                  <option value="" {% if not cliente_preseleccionado %}selected{% endif %}>Seleccione un cliente</option>
                  {% for cliente in clientes %}
                    <option value="{{ cliente.id }}" data-descuento="{{ cliente.tipo_cliente.descuento }}" 
                            {% if cliente_preseleccionado and cliente.id|stringformat:"s" == cliente_preseleccionado %}selected{% endif %}>
                      {{ cliente.nombre_comercial }} — {{ cliente.tipo_cliente.nombre }} 
                      ({{ cliente.tipo_cliente.descuento }}% descuento)
                    </option>
                  {% empty %}
                    <option value="" disabled>No hay clientes asociados</option>
                  {% endfor %}
                </select>
                <div class="form-text">
                Las compras de divisas requieren cliente para aplicar descuentos y controlar límites.
                </div>
              </div>
            </div>

            <!-- Método de Cobro -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label for="metodo_cobro" class="form-label">
                  <i class="fas fa-credit-card me-1"></i>
                  Método de Cobro <span class="text-danger">*</span>
                </label>
                <select id="metodo_cobro" name="metodo_cobro_id" class="form-select" required>
                  <option value="">Seleccione un método de cobro</option>
                  {% for metodo in metodos_cobro %}
                    <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                      {{ metodo.nombre }} 
                      {% if metodo.comision > 0 %}({{ metodo.comision }}% comisión){% else %}(sin comisión){% endif %}
                    </option>
                  {% empty %}
                    <option value="" disabled>No hay métodos de cobro activos</option>
                  {% endfor %}
                </select>
                <div class="form-text">Seleccione cómo desea pagar por las divisas.</div>
              </div>
            </div>

            <!-- Método de Entrega/Pago -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label for="metodo_pago" class="form-label">
                  <i class="fas fa-hand-holding-usd me-1"></i>
                  Método de Entrega <span class="text-danger">*</span>
                </label>
                <select id="metodo_pago" name="metodo_pago_id" class="form-select" required>
                  <option value="">Seleccione cómo recibirá las divisas</option>
                  {% for metodo in metodos_pago %}
                    <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                      {{ metodo.nombre }} 
                      {% if metodo.comision > 0 %}({{ metodo.comision }}% comisión){% else %}(sin comisión){% endif %}
                    </option>
                  {% empty %}
                    <option value="" disabled>No hay métodos de entrega activos</option>
                  {% endfor %}
                </select>
                <div class="form-text">Seleccione cómo recibirá las divisas compradas.</div>
              </div>
            </div>

            <!-- Configuración de la Operación -->
            <div class="row g-3 mb-4">
              <div class="col-12 col-md-4">
                <label for="monto" class="form-label">
                  <i class="fas fa-calculator me-1"></i>
                  Monto <span class="text-danger">*</span>
                </label>
                <input id="monto" name="monto" type="number" class="form-control" 
                       placeholder="0.00" step="any" min="0.01" required
                       {% if cantidad_preseleccionada %}value="{{ cantidad_preseleccionada }}"{% endif %}>
              </div>
              <div class="col-12 col-md-4">
                <label for="moneda_origen" class="form-label">Pagando con</label>
                <select id="moneda_origen" name="moneda_origen" class="form-select" required readonly>
                  <option value="PYG" selected>Guaraní (PYG)</option>
                </select>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Las compras siempre se pagan en Guaraníes
                </div>
              </div>
              <div class="col-12 col-md-4">
                <label for="moneda_destino" class="form-label">Comprando</label>
                <select id="moneda_destino" name="moneda_destino" class="form-select" required>
                  {% for moneda in monedas %}
                    <option value="{{ moneda.codigo }}" 
                      {% if moneda_destino_preseleccionada == moneda.codigo %}selected
                      {% elif not moneda_destino_preseleccionada and moneda.codigo == 'USD' %}selected
                      {% endif %}>
                      {{ moneda.nombre }} ({{ moneda.codigo }})
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Preview del Cálculo -->
            <div id="preview" class="alert alert-light border mb-4" style="display: none;">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-calculator me-2 text-primary"></i>
                <strong>Vista Previa del Cálculo</strong>
              </div>
              <div id="preview-content">
                <!-- Se llenará dinámicamente -->
              </div>
            </div>


            <!-- Botones de Acción -->
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" id="btnCalcular" class="btn btn-outline-primary">
                <i class="fas fa-calculator me-1"></i>
                Calcular
              </button>
              <button type="submit" id="btnComprar" class="btn btn-success" disabled>
                <i class="fas fa-shopping-cart me-1"></i>
                Proceder con la Compra
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Información adicional -->
      <div class="card shadow-sm mt-4">
        <div class="card-body">
          <h6 class="card-title">
            <i class="fas fa-info-circle me-2 text-info"></i>
            Información Importante
          </h6>
          <ul class="mb-0">
            <li>Las transacciones tienen un tiempo límite de <strong>5 minutos</strong> para completar el pago.</li>
            <li>Los tipos de cliente con descuentos aplican automáticamente a la comisión.</li>
            <li>Una vez iniciada la compra, recibirá un código de verificación único para su transacción.</li>
            <li>Puede cancelar la transacción antes de realizar el pago sin penalización.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Datos de métodos de pago para JavaScript
window.metodosPagoData = [
    {% for metodo in metodos_pago %}
    {
        id: {{ metodo.id }},
        nombre: "{{ metodo.nombre|escapejs }}",
        activo: {{ metodo.es_activo|yesno:"true,false" }},
        monedas_permitidas: [
            {% for moneda in metodo.monedas_permitidas.all %}"{{ moneda.codigo }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formCompra');
    const btnCalcular = document.getElementById('btnCalcular');
    const btnComprar = document.getElementById('btnComprar');
    const preview = document.getElementById('preview');
    const previewContent = document.getElementById('preview-content');
    
    const monto = document.getElementById('monto');
    const monedaOrigen = document.getElementById('moneda_origen');
    const monedaDestino = document.getElementById('moneda_destino');
    const cliente = document.getElementById('cliente');
    const metodoCobro = document.getElementById('metodo_cobro');
    const metodoPago = document.getElementById('metodo_pago');
    
    // Función para validar si se puede proceder con la compra
    function validarFormularioCompleto() {
        const esValido = cliente.value && 
                        metodoCobro.value && 
                        metodoPago.value &&
                        monto.value && 
                        parseFloat(monto.value) > 0 &&
                        monedaDestino.value;
        return esValido;
    }
    
    // Función para calcular preview
    async function calcularPreview() {
        const datos = {
            monto: monto.value,
            origen: 'PYG',
            destino: monedaDestino.value,
            cliente_id: cliente.value || null,
            metodo_cobro_id: metodoCobro.value || null,
            metodo_pago_id: metodoPago.value || null
        };
        
        if (!datos.monto || parseFloat(datos.monto) <= 0) {
            preview.style.display = 'none';
            btnComprar.disabled = true;
            return;
        }
        
        try {
            const params = new URLSearchParams();
            params.append('monto', datos.monto);
            params.append('origen', datos.origen);
            params.append('destino', datos.destino);
            if (datos.cliente_id) params.append('cliente_id', datos.cliente_id);
            if (metodoCobro.value) params.append('metodo_cobro_id', metodoCobro.value);
            if (metodoPago.value) params.append('metodo_pago_id', metodoPago.value);
            
            const response = await fetch(`{% url 'transacciones:api_calcular_compra_completa' %}?${params}`);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                previewContent.innerHTML = `
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted">Subtotal:</small><br>
                            <strong>${data.subtotal_formateado}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Tasa utilizada (${data.tipo_operacion}):</small><br>
                            <strong>₲ ${data.precio_usado.toLocaleString()}</strong>
                        </div>
                        ${data.comision_cobro > 0 ? `
                        <div class="col-6">
                            <small class="text-muted">Comisión cobro:</small><br>
                            <span class="text-danger">${data.comision_cobro_formateado} (${data.metodo_cobro.comision}%)</span>
                        </div>
                        ` : ''}
                        ${data.comision_pago > 0 ? `
                        <div class="col-6">
                            <small class="text-muted">Comisión entrega:</small><br>
                            <span class="text-danger">${data.comision_pago_formateado} (${data.metodo_pago.comision}%)</span>
                        </div>
                        ` : ''}
                        ${data.comision_total > 0 ? `
                        <div class="col-12">
                            <hr class="my-1">
                            <small class="text-muted">Total comisiones:</small><br>
                            <strong class="text-danger">${data.comision_total_formateado}</strong>
                        </div>
                        ` : ''}
                        <div class="col-12">
                            <hr class="my-1">
                            <small class="text-muted">Total a pagar:</small><br>
                            <strong class="text-primary fs-5">${data.total_formateado}</strong>
                        </div>
                        <div class="col-12">
                            <small class="text-muted">Recibirá:</small><br>
                            <strong class="text-success fs-5">${data.resultado_formateado}</strong>
                        </div>
                        ${data.descuento_pct > 0 ? `
                        <div class="col-6">
                            <small class="text-muted">Descuento aplicado:</small><br>
                            <span class="text-success">${data.descuento_aplicado_formateado} (${data.descuento_pct}%)</span>
                        </div>
                        ` : ''}
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <small class="text-muted">${data.detalle}</small>
                    </div>
                `;
                
                // Validar límites antes de habilitar el botón de compra
                try {
                    const limitesParams = new URLSearchParams({
                        monto: datos.monto,
                        moneda_origen: 'PYG'
                    });
                    if (datos.cliente_id) limitesParams.append('cliente_id', datos.cliente_id);
                    
                    const limitesResponse = await fetch(`{% url 'transacciones:api_validar_limites' %}?${limitesParams.toString()}`);
                    const limitesResult = await limitesResponse.json();
                    
                    if (!limitesResult.valido) {
                        // Agregar alerta de límites excedidos
                        const alertaLimites = `
                            <div class="alert alert-danger alert-sm mt-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Límites excedidos:</strong> ${limitesResult.mensaje}
                            </div>
                        `;
                        previewContent.innerHTML += alertaLimites;
                        btnComprar.disabled = true;
                    } else {
                        // Mostrar información de límites aplicables
                        if (limitesResult.limites_aplicados && limitesResult.limites_aplicados.length > 0) {
                            const infoLimites = `
                                <div class="alert alert-info alert-sm mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Límites aplicables:</strong><br>
                                    <small>${limitesResult.limites_aplicados.join('<br>')}</small>
                                </div>
                            `;
                            previewContent.innerHTML += infoLimites;
                        }
                        btnComprar.disabled = !validarFormularioCompleto();
                    }
                } catch (limitesError) {
                    console.warn('Error al validar límites:', limitesError);
                    btnComprar.disabled = !validarFormularioCompleto(); // Validar formulario aunque no se puedan validar límites
                }
                
                preview.style.display = 'block';
            } else {
                console.error('Error en cálculo:', result.error);
                previewContent.innerHTML = `<div class="text-danger">Error: ${result.error || 'Error desconocido'}</div>`;
                preview.style.display = 'block';
                btnComprar.disabled = true;
            }
        } catch (error) {
            console.error('Error al calcular:', error);
            previewContent.innerHTML = '<div class="text-danger">Error al calcular. Intente nuevamente.</div>';
            preview.style.display = 'block';
            btnComprar.disabled = true;
        }
    }
    
    // Función para mostrar información de límites
    async function mostrarInfoLimites() {
        const infoLimites = document.getElementById('info-limites');
        const contenidoLimites = document.getElementById('contenido-limites');
        
        if (!monto.value || parseFloat(monto.value) <= 0) {
            infoLimites.style.display = 'none';
            return;
        }
        
        try {
            const params = new URLSearchParams({
                monto: monto.value,
                moneda_origen: 'PYG'
            });
            if (cliente.value) params.append('cliente_id', cliente.value);
            
            const response = await fetch(`{% url 'transacciones:api_validar_limites' %}?${params.toString()}`);
            const result = await response.json();
            
            if (result.limites_aplicados && result.limites_aplicados.length > 0) {
                contenidoLimites.innerHTML = `
                    <ul class="mb-0">
                        ${result.limites_aplicados.map(limite => `<li>${limite}</li>`).join('')}
                    </ul>
                `;
                infoLimites.style.display = 'block';
            } else {
                infoLimites.style.display = 'none';
            }
        } catch (error) {
            console.warn('Error al obtener información de límites:', error);
            infoLimites.style.display = 'none';
        }
    }

    // Función para actualizar métodos de pago según moneda destino
    function actualizarMetodosPago() {
        const monedaDestinoCodigo = monedaDestino.value;
        
        // Resetear el selector de método de pago
        metodoPago.innerHTML = '<option value="">Seleccione un método de entrega</option>';
        
        if (!monedaDestinoCodigo) {
            metodoPago.disabled = true;
            return;
        }
        
        // Filtrar métodos de pago que permiten la moneda seleccionada
        const metodosPagoFiltrados = window.metodosPagoData.filter(metodo => {
            return metodo.monedas_permitidas.includes(monedaDestinoCodigo);
        });
        
        if (metodosPagoFiltrados.length === 0) {
            metodoPago.disabled = true;
            metodoPago.innerHTML = '<option value="">No hay métodos disponibles para esta moneda</option>';
            return;
        }
        
        metodoPago.disabled = false;
        metodosPagoFiltrados.forEach(metodo => {
            const option = document.createElement('option');
            option.value = metodo.id;
            option.textContent = metodo.nombre;
            if (metodo.comision && metodo.comision > 0) {
                option.textContent += ` (${metodo.comision}% comisión)`;
            } else {
                option.textContent += ' (sin comisión)';
            }
            if (!metodo.activo) {
                option.textContent += ' (Inactivo)';
                option.disabled = true;
            }
            metodoPago.appendChild(option);
        });
    }

    // Event listeners
    btnCalcular.addEventListener('click', calcularPreview);
    
    // Actualizar métodos de pago cuando cambie la moneda destino
    monedaDestino.addEventListener('change', actualizarMetodosPago);
    
    // Auto-calcular cuando cambien los valores
    [monto, monedaDestino, cliente, metodoCobro, metodoPago].forEach(element => {
        element.addEventListener('change', function() {
            if (monto.value && parseFloat(monto.value) > 0) {
                calcularPreview();
                mostrarInfoLimites();
            } else {
                // Si no hay monto válido, deshabilitar botón
                btnComprar.disabled = true;
                preview.style.display = 'none';
            }
        });
    });
    
    // Validar formulario completo cuando cambien campos obligatorios
    [cliente, metodoCobro, metodoPago].forEach(element => {
        element.addEventListener('change', function() {
            if (!validarFormularioCompleto()) {
                btnComprar.disabled = true;
            }
        });
    });
    
    // Mostrar límites cuando se cargue la página o cambien valores críticos
    [monto, cliente].forEach(element => {
        element.addEventListener('input', function() {
            clearTimeout(element.limitesTimer);
            element.limitesTimer = setTimeout(mostrarInfoLimites, 300);
        });
    });
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!cliente.value) {
            alert('Por favor seleccione un cliente. Las compras requieren cliente.');
            cliente.focus();
            return;
        }
        
        if (!metodoCobro.value) {
            alert('Por favor seleccione un método de cobro.');
            return;
        }
        
        if (!metodoPago.value) {
            alert('Por favor seleccione un método de entrega/pago.');
            return;
        }
        
        if (!monto.value || parseFloat(monto.value) <= 0) {
            alert('Por favor ingrese un monto válido.');
            return;
        }
        
        // Enviar a iniciar_compra con metodo_cobro_id
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', form.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('monto', monto.value);
        formData.append('moneda_origen', 'PYG');
        formData.append('moneda_destino', monedaDestino.value);
        formData.append('cliente_id', cliente.value);
        formData.append('metodo_cobro_id', metodoCobro.value); // Aquí usamos metodo_cobro_id
        formData.append('metodo_pago_id', metodoPago.value); // Agregar método de pago
        
        // Deshabilitar botón mientras se procesa
        btnComprar.disabled = true;
        btnComprar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        
        fetch('{% url "transacciones:iniciar_compra" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(text => {
                    throw new Error('Error en la respuesta del servidor');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la compra. Intente nuevamente.');
            btnComprar.disabled = false;
            btnComprar.innerHTML = '<i class="fas fa-shopping-cart me-1"></i>Proceder con la Compra';
        });
    });
    
    // Configuración inicial de métodos de pago
    actualizarMetodosPago();
    
    // Si hay valores preseleccionados desde el simulador, hacer cálculo inicial
    {% if cantidad_preseleccionada and moneda_destino_preseleccionada %}
        // Esperar un momento para que se carguen los elementos
        setTimeout(function() {
            const btnCalcular = document.getElementById('btnCalcular');
            if (btnCalcular) {
                btnCalcular.click();
            }
        }, 500);
    {% endif %}
});
</script>
{% endblock %}