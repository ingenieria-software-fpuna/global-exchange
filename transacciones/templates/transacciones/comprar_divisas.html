{% extends "base.html" %}
{% load moneda_extras %}

{% block title %}{{ titulo }} - Transacciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'auth:dashboard' %}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'tasa_cambio:dashboard' %}"><i class="fas fa-chart-line me-1"></i>Simulador</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
    </ol>
  </nav>

  <div class="card shadow-sm">
    <div class="card-header">
      <strong>{{ titulo }}</strong>
    </div>
    <div class="card-body">
      <!-- Información -->
      <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        Ingrese cuánta divisa extranjera necesita y calculamos cuánto debe pagar en Guaraníes.
      </div>

      <form id="formCompra" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <!-- Sección Principal: ¿Qué quiero comprar? -->
          <div class="col-12">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>¿Qué divisa quiere comprar?</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Moneda Destino -->
                  <div class="col-md-6">
                    <label for="moneda_destino" class="form-label">Quiero comprar <span class="text-danger">*</span></label>
                    <select id="moneda_destino" name="moneda_destino" class="form-select" required>
                      {% for moneda in monedas %}
                        <option value="{{ moneda.codigo }}" 
                          data-simbolo="{{ moneda.simbolo }}"
                          {% if moneda_destino_preseleccionada == moneda.codigo %}selected
                          {% elif not moneda_destino_preseleccionada and moneda.codigo == 'USD' %}selected
                          {% endif %}>
                          {{ moneda.simbolo }} {{ moneda.nombre }} ({{ moneda.codigo }})
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <!-- Cantidad -->
                  <div class="col-md-6">
                    <label for="cantidad_divisa" class="form-label">Cantidad <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text" id="simbolo-moneda">$</span>
                      <input id="cantidad_divisa" name="cantidad_divisa" type="number" 
                             class="form-control" placeholder="100.00" step="any" min="0.01" required
                             {% if cantidad_preseleccionada %}value="{{ cantidad_preseleccionada }}"{% endif %}>
                    </div>
                    <div class="form-text">
                      Ingrese cuánta divisa necesita
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cliente -->
          <div class="col-md-12">
            <label for="cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
            <select id="cliente" name="cliente_id" class="form-select" required>
              <option value="" {% if not cliente_preseleccionado %}selected{% endif %}>Seleccione un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}" data-descuento="{{ cliente.tipo_cliente.descuento }}" 
                        {% if cliente_preseleccionado and cliente.id|stringformat:"s" == cliente_preseleccionado %}selected{% endif %}>
                  {{ cliente.nombre_comercial }}{% if cliente.tipo_cliente.activo %} — {{ cliente.tipo_cliente.nombre }}{% endif %}
                </option>
              {% empty %}
                <option value="" disabled>No hay clientes asociados</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Seleccione el cliente para aplicar beneficios
            </div>
          </div>
          <div class="col-md-6">
            <label for="metodo_cobro" class="form-label">¿Cómo va a pagar? <span class="text-danger">*</span></label>
            <select id="metodo_cobro" name="metodo_cobro_id" class="form-select" required>
              <option value="">Seleccione un método de pago</option>
              {% for metodo in metodos_cobro %}
                <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                  {{ metodo.nombre }}
                </option>
              {% empty %}
                <option value="" disabled>No hay métodos de cobro activos</option>
              {% endfor %}
            </select>
          </div>

          <!-- Método de Entrega/Pago -->
          <div class="col-md-6">
            <label for="metodo_pago" class="form-label">¿Cómo la recibirá? <span class="text-danger">*</span></label>
            <select id="metodo_pago" name="metodo_pago_id" class="form-select" required>
              <option value="">Seleccione cómo recibirá las divisas</option>
              {% for metodo in metodos_pago %}
                <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                  {{ metodo.nombre }}
                </option>
              {% empty %}
                <option value="" disabled>No hay métodos de entrega activos</option>
              {% endfor %}
            </select>
          </div>

          <!-- Botón Calcular -->
          <div class="col-12 text-center mt-3">
            <button type="button" id="btnCalcular" class="btn btn-outline-primary me-2">
              <i class="fas fa-calculator me-1"></i>
              Calcular cuánto debo pagar
            </button>
          </div>

          <!-- Tauser -->
          <div class="col-md-12">
            <label for="tauser" class="form-label">Punto de Atención <span class="text-danger">*</span></label>
            <select id="tauser" name="tauser_id" class="form-select" required>
              <option value="">Seleccione un punto de atención</option>
              {% for tauser in tausers %}
                <option value="{{ tauser.id }}" data-direccion="{{ tauser.direccion }}" data-horario="{{ tauser.horario_atencion }}">
                  {{ tauser.nombre }} - {{ tauser.direccion }}
                </option>
              {% empty %}
                <option value="" disabled>No hay puntos de atención disponibles</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Seleccione el punto de atención donde se realizará la transacción.
            </div>
          </div>

          <!-- Preview del Cálculo -->
          <div class="col-12">
            <div id="preview" class="mt-3" style="display: none;">
              <div class="card border-primary shadow-sm">
                <div class="card-header bg-light border-primary">
                  <h6 class="mb-0 text-primary"><i class="fas fa-calculator me-2"></i>Vista Previa del Cálculo</h6>
                </div>
                <div class="card-body" id="preview-content">
                  <!-- Content will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botón de Compra -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" id="btnComprar" class="btn btn-success px-4" disabled>
            <i class="fas fa-shopping-cart me-2"></i>
            Confirmar Compra
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Información adicional -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-info text-white">
      <strong><i class="fas fa-lightbulb me-2"></i>Beneficios y Condiciones</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="text-primary"><i class="fas fa-check-circle me-1"></i> Ventajas</h6>
          <ul class="mb-0">
            <li><strong>Descuentos exclusivos</strong> según su tipo de cliente</li>
            <li><strong>Tasas competitivas</strong> actualizadas en tiempo real</li>
            <li><strong>Cálculo transparente</strong> con detalle completo</li>         
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-warning"><i class="fas fa-info-circle me-1"></i> Importante</h6>
          <ul class="mb-0">
            <li>Tiempo límite de <strong>5 minutos</strong> para completar el pago</li>
            <li>Recibirá un <strong>código de verificación único</strong></li>
            <li>Puede cancelar antes del pago sin penalización</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Datos de métodos de pago para JavaScript
window.metodosPagoData = [
    {% for metodo in metodos_pago %}
    {
        id: {{ metodo.id }},
        nombre: "{{ metodo.nombre|escapejs }}",
        activo: {{ metodo.es_activo|yesno:"true,false" }},
        monedas_permitidas: [
            {% for moneda in metodo.monedas_permitidas.all %}"{{ moneda.codigo }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formCompra');
    const btnCalcular = document.getElementById('btnCalcular');
    const btnComprar = document.getElementById('btnComprar');
    const preview = document.getElementById('preview');
    const previewContent = document.getElementById('preview-content');
    
    const cantidadDivisa = document.getElementById('cantidad_divisa');
    const monedaDestino = document.getElementById('moneda_destino');
    const simboloMoneda = document.getElementById('simbolo-moneda');
    const cliente = document.getElementById('cliente');
    const metodoCobro = document.getElementById('metodo_cobro');
    const metodoPago = document.getElementById('metodo_pago');
    const tauser = document.getElementById('tauser');
    
    // Actualizar símbolo de moneda cuando cambie la selección
    function actualizarSimboloMoneda() {
        const selectedOption = monedaDestino.options[monedaDestino.selectedIndex];
        const simbolo = selectedOption.getAttribute('data-simbolo') || '$';
        simboloMoneda.textContent = simbolo;
    }
    
    monedaDestino.addEventListener('change', actualizarSimboloMoneda);
    actualizarSimboloMoneda(); // Inicializar
    
    // Función para validar si se puede proceder con la compra
    function validarFormularioCompleto() {
        const esValido = tauser.value &&
                        cliente.value && 
                        metodoCobro.value && 
                        metodoPago.value &&
                        cantidadDivisa.value && 
                        parseFloat(cantidadDivisa.value) > 0 &&
                        monedaDestino.value;
        return esValido;
    }
    
    // Variable para almacenar el HTML base del preview
    let previewBaseHTML = '';
    let cantidadDeseadaCalculada = null;
    let monedaComprarCalculada = null;
    
    // Función para validar stock y actualizar el preview
    async function validarStockYActualizarPreview(cantidad, moneda, baseHTML) {
        // Restaurar el HTML base antes de agregar alertas
        previewContent.innerHTML = baseHTML;
        
        // Si no hay tauser seleccionado, no validar stock pero habilitar botón si todo está completo
        if (!tauser.value) {
            const formularioCompleto = validarFormularioCompleto();
            btnComprar.disabled = !formularioCompleto;
            return true;
        }
        
        try {
            const stockParams = new URLSearchParams({
                tauser_id: tauser.value,
                moneda_codigo: moneda,
                cantidad: cantidad
            });
            
            const stockResponse = await fetch(`{% url 'transacciones:api_validar_stock_tauser' %}?${stockParams.toString()}`);
            const stockResult = await stockResponse.json();
            
            if (!stockResult.stock_suficiente) {
                // Agregar alerta de stock insuficiente
                const alertaStock = `
                    <div class="alert alert-warning alert-sm mt-2" id="alerta-stock">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Stock insuficiente:</strong> ${stockResult.mensaje}
                    </div>
                `;
                previewContent.innerHTML += alertaStock;
                btnComprar.disabled = true;
                return false;
            } else {
                // Si hay stock suficiente y el preview está visible, verificar formulario completo
                if (preview.style.display !== 'none') {
                    const formularioCompleto = validarFormularioCompleto();
                    btnComprar.disabled = !formularioCompleto;
                }
                return true;
            }
        } catch (stockError) {
            console.error('Error validando stock:', stockError);
            // En caso de error, no habilitar el botón por seguridad
            btnComprar.disabled = true;
            return false;
        }
    }
    
    // Función para calcular preview
    async function calcularPreview() {
        // Validar que haya cantidad de divisa ingresada
        const cantidadDivisaQuiere = cantidadDivisa.value;
        const monedaComprar = monedaDestino.value;
        
        if (!cantidadDivisaQuiere || parseFloat(cantidadDivisaQuiere) <= 0) {
            alert('Por favor ingrese la cantidad de divisa que desea comprar.');
            cantidadDivisa.focus();
            preview.style.display = 'none';
            btnComprar.disabled = true;
            return;
        }
        
        if (!monedaComprar) {
            alert('Por favor seleccione la moneda que desea comprar.');
            monedaDestino.focus();
            preview.style.display = 'none';
            btnComprar.disabled = true;
            return;
        }
        
        try {
            // CÁLCULO INVERSO:
            // Usuario ingresa cuánta divisa quiere (ej: 100 USD)
            // Necesitamos calcular cuánto debe pagar en PYG
            
            // 1. Primero obtenemos las tasas y comisiones
            const params = new URLSearchParams();
            params.append('moneda_destino', monedaComprar);
            if (cliente.value) params.append('cliente_id', cliente.value);
            if (metodoCobro.value) params.append('metodo_cobro_id', metodoCobro.value);
            if (metodoPago.value) params.append('metodo_pago_id', metodoPago.value);
            
            // Hacer una llamada inicial para obtener tasas y comisiones
            // Usamos un monto dummy para obtener las tasas
            params.append('monto', '1000000'); // 1 millón PYG como base
            params.append('origen', 'PYG');
            params.append('destino', monedaComprar);
            if (tauser.value) params.append('tauser_id', tauser.value);
            
            const response = await fetch(`{% url 'transacciones:api_calcular_compra_completa' %}?${params}`);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                
                // 2. Calcular cuánto debe pagar para obtener la cantidad deseada
                const cantidadDeseada = parseFloat(cantidadDivisaQuiere);
                const tasaAjustada = data.tasa_ajustada;
                
                // Obtener porcentajes de comisión
                const comisionCobroPct = data.metodo_cobro ? data.metodo_cobro.comision / 100 : 0;
                const comisionPagoPct = data.metodo_pago ? data.metodo_pago.comision / 100 : 0;
                const comisionTotalPct = comisionCobroPct + comisionPagoPct;
                
                // Fórmula correcta:
                // 1. Subtotal (cantidad × tasa) = monto sin comisiones
                const subtotal = cantidadDeseada * tasaAjustada;
                
                // 2. Comisiones se calculan SOBRE el subtotal
                const comisionCobro = subtotal * comisionCobroPct;
                const comisionPago = subtotal * comisionPagoPct;
                const comisionTotal = comisionCobro + comisionPago;
                
                // 3. Total = subtotal + comisiones
                const totalAPagar = subtotal + comisionTotal;
                
                // Formatear montos usando códigos de moneda
                const formatearPYG = (valor) => `PYG ${Math.round(valor).toLocaleString('es-PY')}`;
                const formatearDivisa = (valor) => `${monedaComprar} ${valor.toLocaleString('es-PY', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Obtener texto de la moneda seleccionada
                const monedaTexto = monedaDestino.options[monedaDestino.selectedIndex].text;
                
                // Diseño limpio y profesional con fórmula correcta
                previewContent.innerHTML = `
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted d-block mb-1">Usted recibirá</small>
                                <div class="h2 mb-0 text-success">
                                    ${formatearDivisa(cantidadDeseada)}
                                </div>
                                <small class="text-muted">${monedaTexto}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning text-center">
                                <small class="text-muted d-block mb-1">Total a pagar</small>
                                <div class="h2 mb-0 text-dark">
                                    ${formatearPYG(totalAPagar)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3">
                        <div class="row g-2 small">
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Tasa base:</span>
                                    <strong>PYG ${data.tasa_base.toLocaleString('es-PY')}</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span class="text-success">Tasa aplicada:</span>
                                    <strong class="text-success">PYG ${tasaAjustada.toLocaleString('es-PY')}</strong>
                                </div>
                            </div>
                            <div class="col-12"><hr class="my-1"></div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Subtotal (cantidad × tasa):</span>
                                    <strong>${formatearPYG(subtotal)}</strong>
                                </div>
                            </div>
                            ${comisionCobro > 0 ? `
                            <div class="col-12">
                                <div class="d-flex justify-content-between text-danger">
                                    <span>+ Comisión cobro (${(comisionCobroPct * 100).toFixed(1)}%):</span>
                                    <strong>${formatearPYG(comisionCobro)}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${comisionPago > 0 ? `
                            <div class="col-12">
                                <div class="d-flex justify-content-between text-danger">
                                    <span>+ Comisión entrega (${(comisionPagoPct * 100).toFixed(1)}%):</span>
                                    <strong>${formatearPYG(comisionPago)}</strong>
                                </div>
                            </div>
                            ` : ''}
                            <div class="col-12"><hr class="my-1"></div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="text-primary">Total a pagar:</strong>
                                    <strong class="text-primary h5 mb-0">${formatearPYG(totalAPagar)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <small class="text-muted">${data.detalle}</small>
                    </div>
                `;
                
                // Guardar el HTML base del preview y datos para validaciones futuras (antes de agregar alertas)
                previewBaseHTML = previewContent.innerHTML;
                cantidadDeseadaCalculada = cantidadDeseada;
                monedaComprarCalculada = monedaComprar;
                
                // Validar stock inicialmente
                const stockSuficienteInicial = await validarStockYActualizarPreview(cantidadDeseada, monedaComprar, previewBaseHTML);
                
                // Si no hay stock suficiente, no continuar con validaciones de límites
                if (!stockSuficienteInicial) {
                    // Actualizar el preview base con la alerta de stock
                    previewBaseHTML = previewContent.innerHTML;
                    preview.style.display = 'block';
                    preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }
                
                // Actualizar preview base después de validación de stock (sin alertas)
                previewBaseHTML = previewContent.innerHTML;
                
                // Validar límites antes de habilitar el botón de compra
                try {
                    const limitesParams = new URLSearchParams({
                        monto: Math.round(totalAPagar),
                        moneda_origen: monedaComprar
                    });
                    if (cliente.value) limitesParams.append('cliente_id', cliente.value);
                    
                    const limitesResponse = await fetch(`{% url 'transacciones:api_validar_limites' %}?${limitesParams.toString()}`);
                    const limitesResult = await limitesResponse.json();
                    
                    if (!limitesResult.valido) {
                        const alertaLimites = `
                            <div class="alert alert-danger mt-3 mb-0 py-2" id="alerta-limites">
                                <small><i class="fas fa-exclamation-triangle me-1"></i>
                                ${limitesResult.mensaje}</small>
                            </div>
                        `;
                        previewContent.innerHTML += alertaLimites;
                        btnComprar.disabled = true;
                    } else {
                        if (limitesResult.limites_aplicados && limitesResult.limites_aplicados.length > 0) {
                            const infoLimites = `
                                <div class="mt-3 text-center" id="info-limites">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> ${limitesResult.limites_aplicados[0]}
                                    </small>
                                </div>
                            `;
                            previewContent.innerHTML += infoLimites;
                        }
                        // Si llegamos aquí, ya validamos stock antes, solo verificar formulario completo
                        const formularioCompleto = validarFormularioCompleto();
                        btnComprar.disabled = !formularioCompleto;
                    }
                } catch (limitesError) {
                    console.error('Error validando límites:', limitesError);
                    // Verificar stock aunque haya error en límites
                    await validarStockYActualizarPreview(cantidadDeseada, monedaComprar, previewBaseHTML);
                }
                
                // Actualizar el HTML base con las alertas de límites (si las hay) para preservarlas
                previewBaseHTML = previewContent.innerHTML;
                
                // Guardar el total calculado para usarlo en el envío
                form.dataset.totalCalculado = Math.round(totalAPagar);
                form.dataset.cantidadDivisa = cantidadDeseada;
                
                preview.style.display = 'block';
                preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                previewContent.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Error:</strong> ${result.error || 'No se pudo calcular el monto'}
                    </div>
                `;
                preview.style.display = 'block';
                btnComprar.disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
            previewContent.innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-times-circle me-2"></i>
                    Error de conexión. Por favor, intente nuevamente.
                </div>
            `;
            preview.style.display = 'block';
            btnComprar.disabled = true;
        }
    }
    
    // Función para actualizar métodos de pago según moneda destino
    function actualizarMetodosPago() {
        const monedaDestinoCodigo = monedaDestino.value;
        
        metodoPago.innerHTML = '<option value="">Seleccione cómo recibirá las divisas</option>';
        
        if (!monedaDestinoCodigo) {
            metodoPago.disabled = true;
            return;
        }
        
        const metodosPagoFiltrados = window.metodosPagoData.filter(metodo => {
            return metodo.monedas_permitidas.includes(monedaDestinoCodigo);
        });
        
        if (metodosPagoFiltrados.length === 0) {
            metodoPago.disabled = true;
            metodoPago.innerHTML = '<option value="">No hay métodos disponibles para esta moneda</option>';
            return;
        }
        
        metodoPago.disabled = false;
        metodosPagoFiltrados.forEach(metodo => {
            const option = document.createElement('option');
            option.value = metodo.id;
            option.textContent = metodo.nombre;
            option.setAttribute('data-comision', metodo.comision || 0);
            
            if (!metodo.activo) {
                option.textContent += ' (Inactivo)';
                option.disabled = true;
            }
            metodoPago.appendChild(option);
        });
    }

    // Event listeners
    btnCalcular.addEventListener('click', calcularPreview);
    
    // Actualizar métodos de pago cuando cambie la moneda destino
    monedaDestino.addEventListener('change', actualizarMetodosPago);
    
    // Auto-calcular cuando cambien los valores
    {% comment %} [monto, monedaDestino, cliente, metodoCobro, metodoPago, tauser].forEach(element => {
        element.addEventListener('change', function() {
            if (monto.value && parseFloat(monto.value) > 0) {
                calcularPreview();
            } else {
                // Si no hay monto válido, deshabilitar botón
                btnComprar.disabled = true;
                preview.style.display = 'none';
            }
        });
    }); {% endcomment %}
    monedaDestino.addEventListener('change', function() {
        actualizarMetodosPago();
        preview.style.display = 'none';
        btnComprar.disabled = true;
    });
    
    // Auto-calcular NO está habilitado, el usuario debe hacer clic en Calcular
    
    // Validar stock cuando cambie el punto de atención (si ya hay un cálculo previo)
    tauser.addEventListener('change', async function() {
        // Si ya hay un cálculo previo, validar el stock con el nuevo punto de atención
        if (previewBaseHTML && cantidadDeseadaCalculada && monedaComprarCalculada && preview.style.display !== 'none') {
            await validarStockYActualizarPreview(cantidadDeseadaCalculada, monedaComprarCalculada, previewBaseHTML);
        } else {
            // Si no hay cálculo previo, solo deshabilitar el botón
            btnComprar.disabled = true;
        }
    });
    
    // Validar formulario completo cuando cambien campos obligatorios
    [cliente, metodoCobro, metodoPago].forEach(element => {
        element.addEventListener('change', function() {
            if (!validarFormularioCompleto()) {
                btnComprar.disabled = true;
            }
        });
    });
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!tauser.value) {
            alert('Por favor seleccione un punto de atención.');
            tauser.focus();
            return;
        }
        
        if (!cliente.value) {
            alert('Por favor seleccione un cliente.');
            cliente.focus();
            return;
        }
        
        if (!metodoCobro.value) {
            alert('Por favor seleccione un método de pago.');
            return;
        }
        
        if (!metodoPago.value) {
            alert('Por favor seleccione un método de entrega.');
            return;
        }
        
        if (!cantidadDivisa.value || parseFloat(cantidadDivisa.value) <= 0) {
            alert('Por favor ingrese la cantidad de divisa que desea comprar.');
            return;
        }
        
        // Verificar que se haya calculado el total
        if (!form.dataset.totalCalculado) {
            alert('Por favor haga clic en "Calcular" primero.');
            return;
        }
        
        // Enviar a iniciar_compra con la CANTIDAD DE DIVISA que quiere recibir
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', form.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('monto', cantidadDivisa.value); // La cantidad de divisa que quiere recibir
        formData.append('moneda_origen', 'PYG');
        formData.append('moneda_destino', monedaDestino.value);
        formData.append('cliente_id', cliente.value);
        formData.append('metodo_cobro_id', metodoCobro.value);
        formData.append('metodo_pago_id', metodoPago.value);
        formData.append('tauser_id', tauser.value); // Agregar tauser
        
        btnComprar.disabled = true;
        btnComprar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
        
        fetch('{% url "transacciones:iniciar_compra" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                if (response.url.includes('dashboard')) {
                    return response.text().then(text => {
                        throw new Error('La transacción fue rechazada por el servidor');
                    });
                } else {
                    window.location.href = response.url;
                }
            } else {
                return response.text().then(text => {
                    throw new Error('Error en la respuesta del servidor');
                });
            }
        })
        .catch(error => {
            alert('Error al procesar la compra: ' + error.message);
            btnComprar.disabled = false;
            btnComprar.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Confirmar Compra';
        });
    });
    
    // Configuración inicial
    actualizarMetodosPago();
    
    // Si hay valores preseleccionados, calcular automáticamente
    {% if cantidad_preseleccionada and moneda_destino_preseleccionada %}
        setTimeout(function() {
            if (btnCalcular) {
                btnCalcular.click();
            }
        }, 500);
    {% endif %}
});
</script>
{% endblock %}