{% extends "base.html" %}
{% load moneda_extras %}

{% block title %}{{ titulo }} - Transacciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'auth:dashboard' %}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'tasa_cambio:dashboard' %}"><i class="fas fa-chart-line me-1"></i>Simulador</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
    </ol>
  </nav>

  <div class="card shadow-sm">
    <div class="card-header">
      <strong>{{ titulo }}</strong>
    </div>
    <div class="card-body">
      <!-- Información -->
      <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle me-2"></i>
        Ingrese la cantidad de divisa extranjera que desea vender y calculamos cuánto recibirá en Guaraníes.
      </div>

      <form id="formVenta" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <!-- Sección Principal: ¿Qué quiero vender? -->
          <div class="col-12">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark py-2">
                <h6 class="mb-0"><i class="fas fa-hand-holding-usd me-2"></i>¿Qué divisa quiere vender?</h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  <!-- Monto -->
                  <div class="col-md-6">
                    <label for="monto" class="form-label">Cantidad a Vender <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text" id="simbolo-moneda">$</span>
                      <input id="monto" name="monto" type="number" class="form-control" 
                             placeholder="Ej: 100" step="0.01" min="0.01" required
                             {% if cantidad_preseleccionada %}value="{{ cantidad_preseleccionada }}"{% endif %}>
                    </div>
                    <div class="form-text">
                      Ingrese cuánta divisa extranjera tiene para vender
                    </div>
                  </div>

                  <!-- Moneda Origen -->
                  <div class="col-md-6">
                    <label for="moneda_origen" class="form-label">Moneda a Vender <span class="text-danger">*</span></label>
                    <select id="moneda_origen" name="moneda_origen" class="form-select" required>
                      {% for moneda in monedas_origen %}
                        <option value="{{ moneda.codigo }}" 
                                data-simbolo="{{ moneda.simbolo }}"
                                {% if moneda_origen_preseleccionada == moneda.codigo %}selected{% endif %}>
                          {{ moneda.nombre }} ({{ moneda.codigo }})
                        </option>
                      {% empty %}
                        <option value="" disabled>No hay monedas disponibles</option>
                      {% endfor %}
                    </select>
                    <div class="form-text">
                      Seleccione la divisa extranjera
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cliente -->
          <div class="col-md-12">
            <label for="cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
            <select id="cliente" name="cliente_id" class="form-select" required>
              <option value="" {% if not cliente_preseleccionado %}selected{% endif %}>Seleccione un cliente</option>
              {% for cliente in clientes %}
                <option value="{{ cliente.id }}" data-descuento="{{ cliente.tipo_cliente.descuento }}" 
                        {% if cliente_preseleccionado and cliente.id|stringformat:"s" == cliente_preseleccionado %}selected{% endif %}>
                  {{ cliente.nombre_comercial }}{% if cliente.tipo_cliente.activo %} — {{ cliente.tipo_cliente.nombre }} 
                  {% endif %}
                </option>
              {% empty %}
                <option value="" disabled>No hay clientes asociados</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Seleccione el cliente para aplicar beneficios
            </div>
          </div>
          <div class="col-md-6">
            <label for="metodo_cobro" class="form-label">¿Cómo entregará la divisa? <span class="text-danger">*</span></label>
            <select id="metodo_cobro" name="metodo_cobro_id" class="form-select" required>
              <option value="">Seleccione un método de entrega</option>
              {% for metodo in metodos_cobro %}
                <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                  {{ metodo.nombre }}{% if metodo.comision > 0 %} ({{ metodo.comision }}% comisión){% endif %}
                </option>
              {% empty %}
                <option value="" disabled>No hay métodos de cobro activos</option>
              {% endfor %}
            </select>
            <div class="form-text">Seleccione cómo nos entregará la divisa extranjera</div>
          </div>

          <!-- Método de Entrega/Pago -->
          <div class="col-md-6">
            <label for="metodo_pago" class="form-label">¿Cómo recibirá los Guaraníes? <span class="text-danger">*</span></label>
            <select id="metodo_pago" name="metodo_pago_id" class="form-select" required>
              <option value="">Seleccione cómo pagará los Guaraníes</option>
              {% for metodo in metodos_pago %}
                {% if "efectivo" not in metodo.nombre|lower %}
                <option value="{{ metodo.id }}" data-comision="{{ metodo.comision }}">
                  {{ metodo.nombre }} 
                 
                </option>
                {% endif %}
              {% empty %}
                <option value="" disabled>No hay métodos de pago activos</option>
              {% endfor %}
            </select>
            <div class="form-text">Seleccione cómo recibirá los Guaraníes</div>
          </div>

          <!-- Botón Calcular -->
          <div class="col-12 text-center mt-3">
            <button type="button" id="btnCalcular" class="btn btn-outline-primary me-2">
              <i class="fas fa-calculator me-1"></i>
              Calcular cuánto recibiré
            </button>
          </div>

          <!-- Campos del Método de Pago -->
          <div class="col-12" id="campos-metodo-pago" style="display: none;">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="fas fa-list me-2"></i>Información Requerida para el Método de Pago
                </h6>
              </div>
              <div class="card-body" id="campos-container">
                <!-- Los campos se cargarán dinámicamente aquí -->
              </div>
            </div>
          </div>

          <!-- Tauser -->
          <div class="col-md-12">
            <label for="tauser" class="form-label">Punto de Atención <span class="text-danger">*</span></label>
            <select id="tauser" name="tauser_id" class="form-select" required>
              <option value="">Seleccione un punto de atención</option>
              {% for tauser in tausers %}
                <option value="{{ tauser.id }}" data-direccion="{{ tauser.direccion }}" data-horario="{{ tauser.horario_atencion }}">
                  {{ tauser.nombre }} - {{ tauser.direccion }}
                </option>
              {% empty %}
                <option value="" disabled>No hay puntos de atención disponibles</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Seleccione el punto de atención donde se realizará la transacción.
            </div>
          </div>

          <!-- Preview del Cálculo -->
          <div class="col-12">
            <div id="preview" class="mt-3" style="display: none;">
              <div class="card border-warning shadow-sm">
                <div class="card-header bg-light border-warning">
                  <h6 class="mb-0 text-warning"><i class="fas fa-calculator me-2"></i>Vista Previa del Cálculo</h6>
                </div>
                <div class="card-body" id="preview-content">
                  <!-- Content will be loaded dynamically -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botón de Venta -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" id="btnVender" class="btn btn-warning px-4" disabled>
            <i class="fas fa-hand-holding-usd me-2"></i>
            Proceder con la Venta
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Información adicional -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-warning text-dark">
      <strong><i class="fas fa-lightbulb me-2"></i>Beneficios y Condiciones</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="text-warning"><i class="fas fa-check-circle me-1"></i> Ventajas</h6>
          <ul class="mb-0">
            <li><strong>Descuentos exclusivos</strong> según su tipo de cliente</li>
            <li><strong>Tasas competitivas</strong> actualizadas en tiempo real</li>
            <li><strong>Cálculo transparente</strong> con detalle completo</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-info"><i class="fas fa-info-circle me-1"></i> Importante</h6>
          <ul class="mb-0">
            <li>Tiempo límite de <strong>5 minutos</strong> para completar el pago</li>
            <li>Recibirá un <strong>código de verificación único</strong></li>
            <li>Puede cancelar antes del pago sin penalización</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formVenta');
    const btnCalcular = document.getElementById('btnCalcular');
    const btnVender = document.getElementById('btnVender');
    const preview = document.getElementById('preview');
    const previewContent = document.getElementById('preview-content');
    
    const monto = document.getElementById('monto');
    const monedaOrigen = document.getElementById('moneda_origen');
    const simboloMoneda = document.getElementById('simbolo-moneda');
    const monedaDestino = document.getElementById('moneda_destino');
    const cliente = document.getElementById('cliente');
    const metodoCobro = document.getElementById('metodo_cobro');
    const metodoPago = document.getElementById('metodo_pago');
    const camposMetodoPago = document.getElementById('campos-metodo-pago');
    const camposContainer = document.getElementById('campos-container');
    const tauser = document.getElementById('tauser');
    
    // Actualizar símbolo de moneda cuando cambie la selección
    function actualizarSimboloMoneda() {
        const selectedOption = monedaOrigen.options[monedaOrigen.selectedIndex];
        const simbolo = selectedOption.getAttribute('data-simbolo') || '$';
        simboloMoneda.textContent = simbolo;
    }
    
    monedaOrigen.addEventListener('change', actualizarSimboloMoneda);
    actualizarSimboloMoneda(); // Inicializar
    
    // Función para cargar campos del método de pago
    async function cargarCamposMetodoPago(metodoPagoId) {
        if (!metodoPagoId) {
            camposMetodoPago.style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`{% url 'metodo_pago:api_campos_metodo_pago' %}?metodo_pago_id=${metodoPagoId}`);
            const result = await response.json();
            
            if (result.success && result.campos.length > 0) {
                camposContainer.innerHTML = '';
                
                result.campos.forEach((campo, index) => {
                    const campoDiv = document.createElement('div');
                    campoDiv.className = 'mb-3';
                    
                    let inputHtml = '';
                    const campoId = `campo_${campo.id}`;
                    const campoName = `campos_metodo_pago[${campo.id}]`;
                    
                    switch (campo.tipo) {
                        case 'text':
                        case 'email':
                        case 'phone':
                            inputHtml = `
                                <input type="${campo.tipo === 'email' ? 'email' : campo.tipo === 'phone' ? 'tel' : 'text'}" 
                                       id="${campoId}" 
                                       name="${campoName}" 
                                       class="form-control campo-metodo-pago" 
                                       placeholder="${campo.placeholder || ''}"
                                       ${campo.max_length ? `maxlength="${campo.max_length}"` : ''}
                                       ${campo.es_obligatorio ? 'required' : ''}
                                       data-campo-id="${campo.id}"
                                       data-regex="${campo.regex_validacion || ''}">
                            `;
                            break;
                        case 'number':
                            inputHtml = `
                                <input type="number" 
                                       id="${campoId}" 
                                       name="${campoName}" 
                                       class="form-control campo-metodo-pago" 
                                       placeholder="${campo.placeholder || ''}"
                                       ${campo.max_length ? `maxlength="${campo.max_length}"` : ''}
                                       ${campo.es_obligatorio ? 'required' : ''}
                                       data-campo-id="${campo.id}"
                                       data-regex="${campo.regex_validacion || ''}">
                            `;
                            break;
                        case 'select':
                            const opciones = campo.opciones ? campo.opciones.split('\n').filter(o => o.trim()) : [];
                            inputHtml = `
                                <select id="${campoId}" 
                                        name="${campoName}" 
                                        class="form-select campo-metodo-pago" 
                                        ${campo.es_obligatorio ? 'required' : ''}
                                        data-campo-id="${campo.id}">
                                    <option value="">Seleccione una opción</option>
                                    ${opciones.map(opcion => `<option value="${opcion.trim()}">${opcion.trim()}</option>`).join('')}
                                </select>
                            `;
                            break;
                        case 'textarea':
                            inputHtml = `
                                <textarea id="${campoId}" 
                                          name="${campoName}" 
                                          class="form-control campo-metodo-pago" 
                                          placeholder="${campo.placeholder || ''}"
                                          ${campo.max_length ? `maxlength="${campo.max_length}"` : ''}
                                          ${campo.es_obligatorio ? 'required' : ''}
                                          data-campo-id="${campo.id}"
                                          data-regex="${campo.regex_validacion || ''}"
                                          rows="3"></textarea>
                            `;
                            break;
                    }
                    
                    campoDiv.innerHTML = `
                        <label for="${campoId}" class="form-label">
                            ${campo.etiqueta} ${campo.es_obligatorio ? '<span class="text-danger">*</span>' : ''}
                        </label>
                        ${inputHtml}
                        <div class="invalid-feedback" id="error_${campoId}"></div>
                    `;
                    
                    camposContainer.appendChild(campoDiv);
                });
                
                camposMetodoPago.style.display = 'block';
                
                // Agregar event listeners para validación en tiempo real
                document.querySelectorAll('.campo-metodo-pago').forEach(input => {
                    // Validar cuando el usuario empieza a escribir (sin mostrar errores)
                    input.addEventListener('input', function() {
                        validarCamposMetodoPago(false);
                        // Revalidar formulario completo y actualizar botón
                        if (monto.value && parseFloat(monto.value) > 0) {
                            calcularPreview();
                        }
                    });
                    
                    // Validar cuando el usuario termina de escribir (sin mostrar errores)
                    input.addEventListener('change', function() {
                        validarCamposMetodoPago(false);
                        // Revalidar formulario completo y actualizar botón
                        if (monto.value && parseFloat(monto.value) > 0) {
                            calcularPreview();
                        }
                    });
                    
                    // Validar cuando el usuario sale del campo (sin mostrar errores)
                    input.addEventListener('blur', function() {
                        validarCamposMetodoPago(false);
                        // Revalidar formulario completo y actualizar botón
                        if (monto.value && parseFloat(monto.value) > 0) {
                            calcularPreview();
                        }
                    });
                    
                    // No mostrar mensaje inmediato al hacer focus
                });
                
                // Validar campos inicialmente (sin mostrar errores)
                validarCamposMetodoPago(false);
                
            } else {
                camposMetodoPago.style.display = 'none';
            }
        } catch (error) {
            console.error('Error cargando campos del método de pago:', error);
            camposMetodoPago.style.display = 'none';
        }
    }
    
    // Función para validar campos del método de pago
    function validarCamposMetodoPago(mostrarErrores = false) {
        let todosValidos = true;
        const campos = document.querySelectorAll('.campo-metodo-pago');
        
        campos.forEach(input => {
            const errorDiv = document.getElementById(`error_${input.id}`);
            let esValido = true;
            let mensajeError = '';
            
            // Validar campo obligatorio
            if (input.hasAttribute('required') && !input.value.trim()) {
                esValido = false;
                mensajeError = 'Este campo es obligatorio';
            }
            
            // Validar regex si existe
            if (esValido && input.value && input.dataset.regex) {
                const regex = new RegExp(input.dataset.regex);
                if (!regex.test(input.value)) {
                    esValido = false;
                    mensajeError = 'El formato no es válido';
                }
            }
            
            // Validar longitud máxima
            if (esValido && input.value && input.maxLength && input.value.length > input.maxLength) {
                esValido = false;
                mensajeError = `Máximo ${input.maxLength} caracteres`;
            }
            
            // Aplicar estilos de validación
            if (esValido) {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                if (errorDiv) errorDiv.textContent = '';
            } else {
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                if (errorDiv && mostrarErrores) {
                    errorDiv.textContent = mensajeError;
                }
                todosValidos = false;
            }
        });
        
        return todosValidos;
    }
    
    // Función para validar si se puede proceder con la venta
    function validarFormularioCompleto() {
        const esValido = tauser.value &&
                        cliente.value && 
                        metodoCobro.value && 
                        metodoPago.value &&
                        monto.value && 
                        parseFloat(monto.value) > 0 &&
                        monedaOrigen.value;
        
        // Validar también los campos del método de pago si existen
        let camposValidos = true;
        const camposMetodoPago = document.querySelectorAll('.campo-metodo-pago');
        if (camposMetodoPago.length > 0) {
            camposValidos = validarCamposMetodoPago();
        }
        
        return esValido && camposValidos;
    }
    
    // Función para cargar métodos de cobro según la moneda seleccionada
    async function cargarMetodosCobro(monedaCodigo) {
        try {
            const response = await fetch(`{% url 'transacciones:api_metodos_cobro_por_moneda' %}?moneda_codigo=${monedaCodigo}`);
            const result = await response.json();
            
            // Limpiar opciones actuales
            metodoCobro.innerHTML = '<option value="">Seleccione un método de entrega</option>';
            
            if (result.success && result.metodos_cobro.length > 0) {
                // Agregar nuevas opciones
                result.metodos_cobro.forEach(metodo => {
                    const option = document.createElement('option');
                    option.value = metodo.id;
                    option.setAttribute('data-comision', metodo.comision);
                    option.textContent = `${metodo.nombre}${metodo.comision > 0 ? ' (' + metodo.comision + '% comisión)' : ''}`;
                    metodoCobro.appendChild(option);
                });
            } else {
                // No hay métodos disponibles para esta moneda
                const option = document.createElement('option');
                option.value = '';
                option.disabled = true;
                option.textContent = `No hay métodos de cobro para ${monedaCodigo}`;
                metodoCobro.appendChild(option);
            }
            
            // Resetear selección y preview
            metodoCobro.value = '';
            preview.style.display = 'none';
            btnVender.disabled = true;
            
        } catch (error) {
            console.error('Error cargando métodos de cobro:', error);
            metodoCobro.innerHTML = '<option value="" disabled>Error cargando métodos de cobro</option>';
        }
    }
    
    // Función para calcular preview
    async function calcularPreview() {
        const datos = {
            monto: monto.value,
            origen: monedaOrigen.value,
            destino: 'PYG',
            cliente_id: cliente.value || null,
            metodo_cobro_id: metodoCobro.value || null,
            metodo_pago_id: metodoPago.value || null,
            tauser_id: tauser.value || null
        };
        
        if (!datos.monto || parseFloat(datos.monto) <= 0) {
            preview.style.display = 'none';
            btnVender.disabled = true;
            return;
        }
        
        try {
            const params = new URLSearchParams();
            params.append('monto', datos.monto);
            params.append('origen', datos.origen);
            params.append('destino', datos.destino);
            if (datos.cliente_id) params.append('cliente_id', datos.cliente_id);
            if (metodoCobro.value) params.append('metodo_cobro_id', metodoCobro.value);
            if (metodoPago.value) params.append('metodo_pago_id', metodoPago.value);
            if (datos.tauser_id) params.append('tauser_id', datos.tauser_id);
            
            const response = await fetch(`{% url 'transacciones:api_calcular_venta_completa' %}?${params}`);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                
                // Formatear montos usando códigos de moneda
                const formatearPYG = (valor) => `PYG ${Math.round(valor).toLocaleString('es-PY')}`;
                const formatearDivisa = (valor, moneda) => `${moneda} ${valor.toLocaleString('es-PY', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Obtener texto de la moneda seleccionada
                const monedaTexto = monedaOrigen.options[monedaOrigen.selectedIndex].text;
                
                previewContent.innerHTML = `
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded text-center">
                                <small class="text-muted d-block mb-1">Usted vende</small>
                                <div class="h2 mb-0 text-warning">
                                    ${formatearDivisa(parseFloat(datos.monto), datos.origen)}
                                </div>
                                <small class="text-muted">${monedaTexto}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-success bg-opacity-10 rounded border border-success text-center">
                                <small class="text-muted d-block mb-1">Usted recibe</small>
                                <div class="h2 mb-0 text-dark">
                                    ${formatearPYG(data.resultado)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3">
                        <div class="row g-2 small">
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Tasa base:</span>
                                    <strong>PYG ${data.tasa_base.toLocaleString('es-PY')}</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex justify-content-between">
                                    <span class="text-success">Tasa aplicada:</span>
                                    <strong class="text-success">PYG ${data.tasa_ajustada.toLocaleString('es-PY')}</strong>
                                </div>
                            </div>
                            <div class="col-12"><hr class="my-1"></div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Subtotal (cantidad × tasa):</span>
                                    <strong>${formatearPYG(parseFloat(datos.monto) * data.tasa_ajustada)}</strong>
                                </div>
                            </div>
                            ${data.comision_cobro > 0 ? `
                            <div class="col-12">
                                <div class="d-flex justify-content-between text-danger">
                                    <span>- Comisión cobro (${data.metodo_cobro.comision}%):</span>
                                    <strong>${formatearPYG(data.comision_cobro)}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${data.comision_pago > 0 ? `
                            <div class="col-12">
                                <div class="d-flex justify-content-between text-danger">
                                    <span>- Comisión entrega (${data.metodo_pago.comision}%):</span>
                                    <strong>${formatearPYG(data.comision_pago)}</strong>
                                </div>
                            </div>
                            ` : ''}
                            <div class="col-12"><hr class="my-1"></div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="text-success">Total a recibir:</strong>
                                    <strong class="text-success h5 mb-0">${formatearPYG(data.resultado)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="text-center">
                        <small class="text-muted">${data.detalle}</small>
                    </div>
                `;
                
                // Validar límites antes de habilitar el botón de venta
                // Para ventas: validar el monto que el cliente va a recibir contra el límite de la moneda que se vende
                try {
                    const limitesParams = new URLSearchParams({
                        monto: data.resultado, // Monto a recibir en PYG
                        moneda_origen: datos.origen // Moneda que se vende (AUD, USD, etc.)
                    });
                    if (datos.cliente_id) limitesParams.append('cliente_id', datos.cliente_id);
                    
                    const limitesResponse = await fetch(`{% url 'transacciones:api_validar_limites' %}?${limitesParams.toString()}`);
                    const limitesResult = await limitesResponse.json();
                    
                    if (!limitesResult.valido) {
                        // Agregar alerta de límites excedidos
                        const alertaLimites = `
                            <div class="alert alert-danger mt-3 mb-0 py-2" id="alerta-limites">
                                <small><i class="fas fa-exclamation-triangle me-1"></i>
                                ${limitesResult.mensaje}</small>
                            </div>
                        `;
                        previewContent.innerHTML += alertaLimites;
                        btnVender.disabled = true;
                    } else {
                        // Mostrar información de límites aplicables
                        if (limitesResult.limites_aplicados && limitesResult.limites_aplicados.length > 0) {
                            const infoLimites = `
                                <div class="mt-3 text-center" id="info-limites">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> ${limitesResult.limites_aplicados[0]}
                                    </small>
                                </div>
                            `;
                            previewContent.innerHTML += infoLimites;
                        }
                        btnVender.disabled = !validarFormularioCompleto();
                    }
                } catch (limitesError) {
                    const formularioCompleto = validarFormularioCompleto();
                    btnVender.disabled = !formularioCompleto; // Validar formulario aunque no se puedan validar límites
                }
                
                preview.style.display = 'block';
                preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                previewContent.innerHTML = `<div class="text-danger">Error: ${result.error || 'Error desconocido'}</div>`;
                preview.style.display = 'block';
                btnVender.disabled = true;
            }
        } catch (error) {
            previewContent.innerHTML = '<div class="text-danger">Error al calcular. Intente nuevamente.</div>';
            preview.style.display = 'block';
            btnVender.disabled = true;
        }
    }

    // Event listeners
    btnCalcular.addEventListener('click', calcularPreview);
    
    // Event listener especial para cambio de moneda origen
    monedaOrigen.addEventListener('change', function() {
        actualizarSimboloMoneda();
        if (this.value) {
            cargarMetodosCobro(this.value);
        }
        preview.style.display = 'none';
        btnVender.disabled = true;
    });
    
    // Event listener para cambio de método de pago
    metodoPago.addEventListener('change', function() {
        if (this.value) {
            cargarCamposMetodoPago(this.value);
        } else {
            camposMetodoPago.style.display = 'none';
        }
        // Revalidar formulario completo
        if (monto.value && parseFloat(monto.value) > 0) {
            calcularPreview();
        }
    });
    
    // Auto-calcular NO está habilitado, el usuario debe hacer clic en Calcular
    // Solo resetear el preview cuando cambien valores que afectan el cálculo
    [monto, cliente, metodoCobro, metodoPago].forEach(element => {
        element.addEventListener('change', function() {
            // Si cambian valores después de calcular, ocultar preview para forzar recalcular
            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                btnVender.disabled = true;
            }
        });
    });
    
    // Validar campos del método de pago cuando cambien (sin auto-calcular)
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('campo-metodo-pago')) {
            validarCamposMetodoPago(false);
            // Si el preview está visible, ocultarlo para forzar recalcular
            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                btnVender.disabled = true;
            }
        }
    });
    
    // Validar formulario completo cuando cambien campos obligatorios
    [tauser, cliente, metodoCobro, metodoPago].forEach(element => {
        element.addEventListener('change', function() {
            if (!validarFormularioCompleto()) {
                btnVender.disabled = true;
            }
        });
    });
    
    // Envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!tauser.value) {
            alert('Por favor seleccione un punto de atención.');
            tauser.focus();
            return;
        }
        
        if (!cliente.value) {
            alert('Por favor seleccione un cliente. Las ventas requieren cliente.');
            cliente.focus();
            return;
        }
        
        if (!metodoCobro.value) {
            alert('Por favor seleccione un método de cobro.');
            return;
        }
        
        if (!metodoPago.value) {
            alert('Por favor seleccione un método de pago.');
            return;
        }
        
        // Validar campos del método de pago (mostrando errores)
        if (!validarCamposMetodoPago(true)) {
            alert('Por favor complete correctamente todos los campos requeridos del método de pago.');
            return;
        }
        
        if (!monto.value || parseFloat(monto.value) <= 0) {
            alert('Por favor ingrese un monto válido.');
            return;
        }
        
        // Enviar a iniciar_venta
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', form.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('monto', monto.value);
        formData.append('moneda_origen', monedaOrigen.value);
        formData.append('moneda_destino', 'PYG');
        formData.append('cliente_id', cliente.value);
        formData.append('metodo_cobro_id', metodoCobro.value);
        formData.append('metodo_pago_id', metodoPago.value);
        formData.append('tauser_id', tauser.value);
        
        // Agregar campos del método de pago
        document.querySelectorAll('.campo-metodo-pago').forEach(input => {
            if (input.value) {
                formData.append(input.name, input.value);
            }
        });
        
        // Deshabilitar botón mientras se procesa
        btnVender.disabled = true;
        btnVender.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        
        fetch('{% url "transacciones:iniciar_venta" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                // Si fue redirigido al dashboard, algo salió mal
                if (response.url.includes('dashboard')) {
                    // No redirigir automáticamente, mostrar error
                    return response.text().then(text => {
                        throw new Error('La transacción fue rechazada por el servidor');
                    });
                } else {
                    // Redirección exitosa (probablemente al resumen)
                    window.location.href = response.url;
                }
            } else {
                return response.text().then(text => {
                    throw new Error('Error en la respuesta del servidor');
                });
            }
        })
        .catch(error => {
            alert('Error al procesar la venta: ' + error.message);
            btnVender.disabled = false;
            btnVender.innerHTML = '<i class="fas fa-hand-holding-usd me-1"></i>Proceder con la Venta';
        });
    });
    
    // Cargar métodos de cobro al inicio si hay moneda preseleccionada
    {% if moneda_origen_preseleccionada %}
        // Cargar métodos de cobro para la moneda preseleccionada
        cargarMetodosCobro('{{ moneda_origen_preseleccionada }}');
    {% else %}
        // Cargar métodos para USD por defecto
        if (monedaOrigen.value) {
            cargarMetodosCobro(monedaOrigen.value);
        }
    {% endif %}
    
    // Si hay valores preseleccionados desde el simulador, hacer cálculo inicial
    {% if cantidad_preseleccionada and moneda_origen_preseleccionada %}
        // Esperar un momento para que se carguen los elementos y métodos de cobro
        setTimeout(function() {
            const btnCalcular = document.getElementById('btnCalcular');
            if (btnCalcular) {
                btnCalcular.click();
            }
        }, 1000); // Aumentar el tiempo para que carguen los métodos
    {% endif %}
});
</script>
{% endblock %}