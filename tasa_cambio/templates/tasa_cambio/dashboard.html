{% extends "base.html" %}
{% load moneda_extras %}

{% block title %}{{ titulo }} - Simulador{% endblock %}

{% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'auth:dashboard' %}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
    </ol>
  </nav>

  <div class="card shadow-sm">
    <div class="card-header">
      <strong>{{ titulo }}</strong>
      <span class="badge bg-light text-dark ms-2">Base: PYG</span>
    </div>
    <div class="card-body">
      <form novalidate>
        <div class="row g-3">
          <!-- Tipo de Operación -->
          <div class="col-md-12">
            <label class="form-label">Tipo de Operación</label>
            <div class="btn-group w-100" role="group" aria-label="Tipo de operación">
              <input type="radio" class="btn-check" name="tipoOperacion" id="operacionComprar" value="comprar" checked>
              <label class="btn btn-outline-success" for="operacionComprar">
                <i class="fas fa-shopping-cart me-2"></i>Quiero Comprar
              </label>
              <input type="radio" class="btn-check" name="tipoOperacion" id="operacionVender" value="vender">
              <label class="btn btn-outline-warning" for="operacionVender">
                <i class="fas fa-hand-holding-usd me-2"></i>Quiero Vender
              </label>
            </div>
            <div class="form-text" id="operacionAyuda">
              Comprando: Ingresa cuánta divisa quieres comprar y te calculamos cuánto pagarás en Guaraníes
            </div>
          </div>

          <!-- Cliente -->
          <div class="col-md-6">
            <label class="form-label">Cliente</label>
            <select id="cliente" class="form-select">
              <option value="">Sin cliente</option>
              {% for c in clientes %}
                <option value="{{ c.id }}">{{ c.nombre_comercial }} — {{ c.tipo_cliente.nombre }}</option>
              {% empty %}
                <option value="" disabled>No tiene clientes asociados</option>
              {% endfor %}
            </select>
          </div>

          <!-- Moneda -->
          <div class="col-md-3">
            <label class="form-label" id="labelMoneda">
              <span id="textoMoneda">Moneda que quiero comprar</span>
            </label>
            <select id="monedaOperacion" class="form-select">
              {% for m in monedas %}
                {% if m.codigo != 'PYG' %}
                  <option value="{{ m.codigo }}" {% if m.codigo == 'USD' %}selected{% endif %}>{{ m.nombre }} ({{ m.codigo }})</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <!-- Monto -->
          <div class="col-md-3">
            <label class="form-label" id="labelMonto">
              <span id="textoMonto">Cantidad que quiero comprar</span>
            </label>
            <div class="input-group">
              <span class="input-group-text" id="simboloMonto">$</span>
              <input id="monto" type="number" class="form-control" placeholder="100" step="any" min="0" value="100">
            </div>
          </div>

          <!-- Resultado -->
          <div class="col-md-12">
            <div id="resultado" class="card bg-light mt-3">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-calculator me-2"></i>
                  Resultado de la Simulación
                </h6>
              </div>
              <div class="card-body">
                <div class="fs-4 fw-bold mb-2" id="resultado_valor">—</div>
                <div class="small text-muted mb-2" id="resultado_detalle">Selecciona monedas y monto para simular.</div>
                <div class="small" id="resultado_subtotal"></div>
                <div class="small text-danger" id="resultado_comision"></div>
                <div class="small" id="resultado_tasas"></div>
                <div class="small text-success" id="resultado_descuento"></div>
                
                <!-- Enlace a Compra de Divisas -->
                <div class="mt-3" id="enlace_compra_container" style="display: none;">
                  <a href="#" id="btnIrCompra" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Ir a Comprar Divisas
                  </a>
                  <div class="text-center mt-2">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      El simulador te ayuda a calcular. Para comprar, usa nuestra pantalla especializada.
                    </small>
                  </div>
                </div>
                
                <!-- Enlace a Venta de Divisas -->
                <div class="mt-3" id="enlace_venta_container" style="display: none;">
                  <a href="#" id="btnIrVenta" class="btn btn-warning btn-lg w-100">
                    <i class="fas fa-hand-holding-usd me-2"></i>
                    Ir a Vender Divisas
                  </a>
                  <div class="text-center mt-2">
                    <small class="text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      El simulador te ayuda a calcular. Para vender, usa nuestra pantalla especializada.
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="monedas-data">{% for m in monedas %}{"codigo": "{{ m.codigo }}", "nombre": "{{ m.nombre|escapejs }}"}{% if not forloop.last %},{% endif %}{% endfor %}</script>
<script>
  (function() {
    // Elementos del DOM
    const $monto = document.getElementById('monto');
    const $monedaOperacion = document.getElementById('monedaOperacion');
    const $cliente = document.getElementById('cliente');
    const $resValor = document.getElementById('resultado_valor');
    const $resDetalle = document.getElementById('resultado_detalle');
    const $resTasas = document.getElementById('resultado_tasas');
    const $resDesc = document.getElementById('resultado_descuento');
    
    // Elementos de la interfaz de operación
    const $operacionComprar = document.getElementById('operacionComprar');
    const $operacionVender = document.getElementById('operacionVender');
    const $textoMonto = document.getElementById('textoMonto');
    const $textoMoneda = document.getElementById('textoMoneda');
    const $simboloMonto = document.getElementById('simboloMonto');
    const $operacionAyuda = document.getElementById('operacionAyuda');

    // Dataset de monedas activas
    const monedasData = JSON.parse('[' + document.getElementById('monedas-data').textContent + ']');
    const MONEDAS = monedasData.filter(m => m.codigo !== 'PYG');

    // Función para actualizar la interfaz según el tipo de operación
    function actualizarInterfazOperacion() {
      const esCompra = $operacionComprar.checked;
      
      if (esCompra) {
        // QUIERO COMPRAR: Ingreso cantidad de divisa, calcula cuánto pagar en PYG
        $textoMoneda.textContent = 'Moneda que quiero comprar';
        $textoMonto.textContent = 'Cantidad que quiero comprar';
        const monedaSeleccionada = MONEDAS.find(m => m.codigo === $monedaOperacion.value);
        const simboloMoneda = monedaSeleccionada ? getSimboloMoneda(monedaSeleccionada.codigo) : '$';
        $simboloMonto.textContent = simboloMoneda;
        $operacionAyuda.textContent = 'Comprando: Ingresa cuánta divisa quieres comprar y te calculamos cuánto pagarás en Guaraníes';
        $monto.placeholder = '100';
      } else {
        // QUIERO VENDER: Entregar otra moneda, recibir PYG
        $textoMonto.textContent = 'Cantidad que quiero vender';
        $textoMoneda.textContent = 'Moneda que quiero vender';
        const monedaSeleccionada = MONEDAS.find(m => m.codigo === $monedaOperacion.value);
        const simboloMoneda = monedaSeleccionada ? getSimboloMoneda(monedaSeleccionada.codigo) : '$';
        $simboloMonto.textContent = simboloMoneda;
        $operacionAyuda.textContent = 'Vendiendo: Selecciona qué moneda quieres vender y recibe Guaraníes';
        $monto.placeholder = '100';
      }
      
      simulate();
    }
    
    // Función para obtener símbolo de moneda
    function getSimboloMoneda(codigo) {
      const simbolos = {
        'USD': '$',
        'EUR': '€',
        'ARS': '$',
        'BRL': 'R$',
        'PYG': '₲'
      };
      return simbolos[codigo] || codigo;
    }

    function simulate() {
      const monto = $monto.value;
      const monedaOperacion = $monedaOperacion.value;
      const cliente = $cliente.value;
      const esCompra = $operacionComprar.checked;
      
      if (!monto || !monedaOperacion || parseFloat(monto) <= 0) {
        limpiarResultados();
        return;
      }

      if (esCompra) {
        // COMPRAR: Usuario especifica cuánta divisa quiere, calculamos PYG a pagar
        // Necesitamos la tasa de VENTA
        simularCompra(monto, monedaOperacion, cliente);
      } else {
        // VENDER: Usuario especifica cuánta divisa vende, calculamos PYG a recibir  
        // Necesitamos la tasa de COMPRA
        simularVenta(monto, monedaOperacion, cliente);
      }
    }
    
    function simularCompra(cantidadDivisa, codigoMoneda, clienteId) {
      // Para compra: consultamos PYG -> Moneda para obtener la tasa de venta
      const params = new URLSearchParams({
        monto: '1',  // Consultamos 1 PYG para obtener el precio unitario
        origen: 'PYG',
        destino: codigoMoneda,
      });
      if (clienteId) params.append('cliente_id', clienteId);

      fetch(`{% url 'tasa_cambio:simular_cambio_api' %}?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            $resValor.textContent = '—';
            $resDetalle.textContent = data.message || 'Error en la simulación.';
            $resTasas.textContent = '';
            $resDesc.textContent = '';
            document.getElementById('enlace_compra_container').style.display = 'none';
            return;
          }
          
          const d = data.data;
          // Obtener el precio de venta desde la respuesta
          const tasaVenta = d.tasa_destino ? parseFloat(d.tasa_destino.valor) : 0;
          
          if (tasaVenta <= 0) {
            $resValor.textContent = '—';
            $resDetalle.textContent = 'No se pudo obtener la tasa de venta.';
            return;
          }
          
          // Calcular PYG necesarios: cantidad_divisa × tasa_venta
          const cantidad = parseFloat(cantidadDivisa);
          const pygNecesarios = Math.round(cantidad * tasaVenta);
          
          // Mostrar resultado
          $resValor.textContent = `₲ ${formatNumberWithDots(pygNecesarios)}`;
          $resDetalle.textContent = `Para comprar ${cantidadDivisa} ${codigoMoneda}, debes pagar:`;
          
          // Mostrar tasa usada
          $resTasas.textContent = `Tasa usada: ${codigoMoneda} (${d.tasa_destino.tipo}): ${formatNumberWithDots(tasaVenta)}`;
          
          // Mostrar descuento si aplica
          if (d.cliente && d.cliente.descuento > 0) {
            $resDesc.textContent = `Cliente: ${d.cliente.nombre} — ${d.cliente.tipo} `;
          } else {
            $resDesc.textContent = '';
          }
          
          // Limpiar campos no usados en compra
          const $resSubtotal = document.getElementById('resultado_subtotal');
          const $resComision = document.getElementById('resultado_comision');
          if ($resSubtotal) $resSubtotal.textContent = '';
          if ($resComision) $resComision.textContent = '';
          
          // Mostrar solo el botón de compra
          document.getElementById('enlace_compra_container').style.display = 'block';
          document.getElementById('enlace_venta_container').style.display = 'none';
        })
        .catch((error) => {
          console.error('Error en simulación de compra:', error);
          mostrarError('No se pudo simular. Error: ' + (error.message || 'Desconocido'));
        });
    }
    
    function simularVenta(cantidadDivisa, codigoMoneda, clienteId) {
      // Para venta: consultamos Moneda -> PYG para usar tasa de compra
      const params = new URLSearchParams({
        monto: String(cantidadDivisa),
        origen: codigoMoneda,
        destino: 'PYG',
      });
      if (clienteId) params.append('cliente_id', clienteId);

      fetch(`{% url 'tasa_cambio:simular_cambio_api' %}?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) {
            mostrarError(data.message || 'Error en la simulación.');
            return;
          }
          
          const d = data.data;
          
          // Mostrar resultado
          $resValor.textContent = formatDisplayWithDots(d.resultado_formateado);
          $resDetalle.textContent = d.detalle;
          
          const $resSubtotal = document.getElementById('resultado_subtotal');
          const $resComision = document.getElementById('resultado_comision');
          if (d.subtotal_formateado) {
            $resSubtotal.textContent = `Sub-total: ${formatDisplayWithDots(d.subtotal_formateado)}`;
          } else { $resSubtotal.textContent = ''; }
          if (d.comision_pct && d.comision_monto_formateado) {
            $resComision.textContent = `Comisión (${d.comision_pct}%): ${formatDisplayWithDots(d.comision_monto_formateado)}`;
          } else { $resComision.textContent = ''; }
          
          const t1 = d.tasa_origen ? `${d.tasa_origen.moneda} (${d.tasa_origen.tipo}): ${d.tasa_origen.valor}` : null;
          const parts = [t1].filter(Boolean);
          $resTasas.textContent = parts.length ? `Tasas usadas: ${parts.join(' · ')}` : '';
          
          if (d.cliente && d.cliente.descuento > 0) {
            $resDesc.textContent = `Cliente: ${d.cliente.nombre} — ${d.cliente.tipo}`;
          } else {
            $resDesc.textContent = '';
          }
          
          // Mostrar solo el botón de venta
          document.getElementById('enlace_compra_container').style.display = 'none';
          document.getElementById('enlace_venta_container').style.display = 'block';
        })
        .catch((error) => {
          console.error('Error en simulación de venta:', error);
          mostrarError('No se pudo simular. Error: ' + (error.message || 'Desconocido'));
        });
    }
    
    function mostrarError(mensaje) {
      $resValor.textContent = '—';
      $resDetalle.textContent = mensaje;
      $resTasas.textContent = '';
      $resDesc.textContent = '';
      const $resSubtotal = document.getElementById('resultado_subtotal');
      const $resComision = document.getElementById('resultado_comision');
      if ($resSubtotal) $resSubtotal.textContent = '';
      if ($resComision) $resComision.textContent = '';
      document.getElementById('enlace_compra_container').style.display = 'none';
      document.getElementById('enlace_venta_container').style.display = 'none';
    }
    
    function formatNumberWithDots(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    function limpiarResultados() {
      $resValor.textContent = '—';
      $resDetalle.textContent = 'Ingresa un monto válido para simular.';
      $resTasas.textContent = '';
      $resDesc.textContent = '';
      const $resSubtotal = document.getElementById('resultado_subtotal');
      const $resComision = document.getElementById('resultado_comision');
      if ($resSubtotal) $resSubtotal.textContent = '';
      if ($resComision) $resComision.textContent = '';
      document.getElementById('enlace_compra_container').style.display = 'none';
      document.getElementById('enlace_venta_container').style.display = 'none';
    }

    // Event listeners
    $monto.addEventListener('input', simulate);
    $monedaOperacion.addEventListener('change', function() {
      // Actualizar símbolo de moneda si estamos vendiendo
      if ($operacionVender.checked) {
        const monedaSeleccionada = MONEDAS.find(m => m.codigo === $monedaOperacion.value);
        const simboloMoneda = monedaSeleccionada ? getSimboloMoneda(monedaSeleccionada.codigo) : '$';
        $simboloMonto.textContent = simboloMoneda;
      }
      simulate();
    });
    $cliente.addEventListener('change', simulate);
    $operacionComprar.addEventListener('change', actualizarInterfazOperacion);
    $operacionVender.addEventListener('change', actualizarInterfazOperacion);

    // Inicializar dirección por defecto (PYG -> USD)
    // Helpers: format numbers with dot thousands separators
    function formatDisplayWithDots(str) {
      if (!str) return str;
      const m = String(str).match(/^(\D*)([-\d.,]+)(.*)$/);
      if (!m) return str;
      const prefix = m[1] || '';
      const number = m[2] || '';
      const suffix = m[3] || '';
      // Detect decimal separator as last occurrence of '.' or ','
      const lastDot = number.lastIndexOf('.');
      const lastComma = number.lastIndexOf(',');
      let decSepIndex = Math.max(lastDot, lastComma);
      let intPart = number;
      let decPart = '';
      let sep = '';
      if (decSepIndex > -1) {
        sep = number[decSepIndex];
        intPart = number.slice(0, decSepIndex);
        decPart = number.slice(decSepIndex + 1);
      }
      // Remove existing thousand separators (',' or '.') from intPart just in case, keep minus
      const neg = intPart.startsWith('-');
      const intDigits = intPart.replace(/[^\d]/g, '');
      const grouped = intDigits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      const intFinal = neg ? '-' + grouped : grouped;
      const numFinal = decPart ? `${intFinal}${sep}${decPart}` : intFinal;
      return `${prefix}${numFinal}${suffix}`;
    }

    // Configurar enlace dinámico a compras
    document.getElementById('btnIrCompra').addEventListener('click', function(e) {
        e.preventDefault();
        
        const esCompra = $operacionComprar.checked;
        const cantidad = $monto.value;
        const cliente = $cliente.value;
        
        let url = "{% url 'transacciones:comprar_divisas' %}";
        
        // Solo redirigir a compras si es una operación de compra
        if (esCompra && cantidad && $monedaOperacion.value) {
            const params = new URLSearchParams({
                'moneda_origen': 'PYG',
                'moneda_destino': $monedaOperacion.value,
                'cantidad': cantidad
            });
            
            if (cliente) {
                params.append('cliente_id', cliente);
            }
            
            url += '?' + params.toString();
            window.location.href = url;
        } else {
            alert('La pantalla de compras solo está disponible para operaciones de "Quiero Comprar"');
        }
    });
    
    // Configurar enlace dinámico a ventas
    document.getElementById('btnIrVenta').addEventListener('click', function(e) {
        e.preventDefault();
        
        const esVenta = $operacionVender.checked;
        const cantidad = $monto.value;
        const cliente = $cliente.value;
        
        let url = "{% url 'transacciones:vender_divisas' %}";
        
        // Solo redirigir a ventas si es una operación de venta
        if (esVenta && cantidad && $monedaOperacion.value) {
            const params = new URLSearchParams({
                'moneda_origen': $monedaOperacion.value,
                'moneda_destino': 'PYG',
                'cantidad': cantidad
            });
            
            if (cliente) {
                params.append('cliente_id', cliente);
            }
            
            url += '?' + params.toString();
            window.location.href = url;
        } else {
            alert('La pantalla de ventas solo está disponible para operaciones de "Quiero Vender"');
        }
    });

    // Inicialización
    actualizarInterfazOperacion();
    simulate();
  })();
</script>
{% endblock %}
