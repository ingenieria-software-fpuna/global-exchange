{% extends "base.html" %}

{% block title %}{{ titulo }} - Cotizaciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'auth:dashboard' %}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{% url 'tasa_cambio:tasacambio_list' %}"><i class="fas fa-chart-line me-1"></i>Cotizaciones</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ titulo }}</li>
    </ol>
  </nav>

  <div class="card shadow-sm">
    <div class="card-header">
      <strong>{{ titulo }}</strong>
    </div>
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}
        <div class="row g-3">
          <!-- Moneda -->
          <div class="col-md-12">
            <label class="form-label" for="{{ form.moneda.id_for_label }}">{{ form.moneda.label }}</label>
            {{ form.moneda }}
            {% for e in form.moneda.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.moneda.help_text %}
              <div class="form-text">{{ form.moneda.help_text }}</div>
            {% endif %}
          </div>
          
          <!-- Precio Base -->
          <div class="col-md-4">
            <label class="form-label" for="{{ form.precio_base.id_for_label }}">{{ form.precio_base.label }}</label>
            {{ form.precio_base }}
            {% for e in form.precio_base.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.precio_base.help_text %}
              <div class="form-text">{{ form.precio_base.help_text }}</div>
            {% endif %}
          </div>
          
          <!-- Comisión de Compra -->
          <div class="col-md-4">
            <label class="form-label" for="{{ form.comision_compra.id_for_label }}">{{ form.comision_compra.label }}</label>
            {{ form.comision_compra }}
            {% for e in form.comision_compra.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.comision_compra.help_text %}
              <div class="form-text">{{ form.comision_compra.help_text }}</div>
            {% endif %}
          </div>
          
          <!-- Comisión de Venta -->
          <div class="col-md-4">
            <label class="form-label" for="{{ form.comision_venta.id_for_label }}">{{ form.comision_venta.label }}</label>
            {{ form.comision_venta }}
            {% for e in form.comision_venta.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.comision_venta.help_text %}
              <div class="form-text">{{ form.comision_venta.help_text }}</div>
            {% endif %}
          </div>
          
          <!-- Tasa de Compra -->
          <div class="col-md-6">
            <label class="form-label" for="{{ form.tasa_compra.id_for_label }}">{{ form.tasa_compra.label }}</label>
            {{ form.tasa_compra }}
            {% for e in form.tasa_compra.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.tasa_compra.help_text %}
              <div class="form-text">{{ form.tasa_compra.help_text }}</div>
            {% endif %}
          </div>

          <!-- Tasa de Venta -->
          <div class="col-md-6">
            <label class="form-label" for="{{ form.tasa_venta.id_for_label }}">{{ form.tasa_venta.label }}</label>
            {{ form.tasa_venta }}
            {% for e in form.tasa_venta.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.tasa_venta.help_text %}
              <div class="form-text">{{ form.tasa_venta.help_text }}</div>
            {% endif %}
          </div>

          <!-- Fecha de Vigencia -->
          <div class="col-md-12">
            <label class="form-label" for="{{ form.fecha_vigencia.id_for_label }}">{{ form.fecha_vigencia.label }}</label>
            {{ form.fecha_vigencia }}
            {% for e in form.fecha_vigencia.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            {% if form.fecha_vigencia.help_text %}
              <div class="form-text">{{ form.fecha_vigencia.help_text }}</div>
            {% endif %}
          </div>

          <!-- Vista previa de precios calculados -->
          <div class="col-md-12">
            <div class="card bg-light mt-3">
              <div class="card-header">
                <h6 class="mb-0">
                  <i class="fas fa-calculator me-2"></i>
                  Precios Calculados
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="text-center">
                      <h5 class="text-success">Precio de Compra</h5>
                      <span class="badge bg-success fs-4" id="precio-compra">-</span>
                      <small class="d-block text-muted mt-1">Precio Base - Comisión Compra</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="text-center">
                      <h5 class="text-danger">Precio de Venta</h5>
                      <span class="badge bg-danger fs-4" id="precio-venta">-</span>
                      <small class="d-block text-muted mt-1">Precio Base + Comisión Venta</small>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-12 text-center">
                    <small class="text-info">
                      <i class="fas fa-info-circle me-1"></i>
                      Los precios se actualizan automáticamente al cambiar los valores
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {% if form.es_activa %}
          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              {{ form.es_activa }}
              <label class="form-check-label" for="{{ form.es_activa.id_for_label }}">{{ form.es_activa.label }}</label>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Errores generales del formulario -->
        {% if form.non_field_errors %}
          <div class="alert alert-danger mt-3">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div class="d-flex justify-content-end mt-4">
          <a href="{% url 'tasa_cambio:tasacambio_list' %}" class="btn btn-outline-secondary me-2">Cancelar</a>
          <button type="submit" class="btn btn-primary">{{ accion }}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Validación en tiempo real de tasas
document.addEventListener('DOMContentLoaded', function() {
    const precioBase = document.getElementById('{{ form.precio_base.id_for_label }}');
    const comisionCompra = document.getElementById('{{ form.comision_compra.id_for_label }}');
    const comisionVenta = document.getElementById('{{ form.comision_venta.id_for_label }}');
    const precioCompraDisplay = document.getElementById('precio-compra');
    const precioVentaDisplay = document.getElementById('precio-venta');
    
    // Función para calcular y mostrar precios
    function calcularPrecios() {
        const base = parseInt(precioBase.value) || 0;
        const compra = parseInt(comisionCompra.value) || 0;
        const venta = parseInt(comisionVenta.value) || 0;
        
        const precioCompraCalculado = base - compra;
        const precioVentaCalculado = base + venta;
        
        // Mostrar valores sin formato especial (solo números)
        if (precioCompraCalculado <= 0 || compra<0 ) {
            precioCompraDisplay.className = 'badge bg-warning fs-4';
            precioCompraDisplay.textContent = 'Inválido';
        } else {
            precioCompraDisplay.className = 'badge bg-success fs-4';
            precioCompraDisplay.textContent = '₲ ' + precioCompraCalculado.toLocaleString('es-PY');
        }
        
        if (precioVentaCalculado <= 0 || venta<0 ) {
            precioVentaDisplay.className = 'badge bg-warning fs-4';
            precioVentaDisplay.textContent = 'Inválido';
        } else {
            precioVentaDisplay.className = 'badge bg-danger fs-4';
            precioVentaDisplay.textContent = '₲ ' + precioVentaCalculado.toLocaleString('es-PY');
        }
    }
    
    // Event listeners para cálculo en tiempo real
    precioBase.addEventListener('input', calcularPrecios);
    comisionCompra.addEventListener('input', calcularPrecios);
    comisionVenta.addEventListener('input', calcularPrecios);
    
    // Calcular precios iniciales
    calcularPrecios();
});
</script>
{% endblock %}