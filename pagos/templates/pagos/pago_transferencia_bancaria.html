{% extends "base.html" %}
{% load moneda_extras %}

{% block title %}Pago con Transferencia Bancaria{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      
      <!-- Header -->
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h1 class="h3 mb-2">
            <i class="fas fa-university me-2"></i>
            Pago con Transferencia Bancaria
          </h1>
          <p class="text-muted mb-0">ID Transacción: <strong>{{ transaccion.id_transaccion }}</strong></p>
        </div>
      </div>

      <!-- Temporizador de expiración -->
      {% if tiempo_restante > 0 %}
      <div class="alert alert-warning" id="temporizador-alert" data-tiempo-restante="{{ tiempo_restante }}">
        <div class="d-flex align-items-center">
          <i class="fas fa-clock me-2"></i>
          <div>
            <strong>Tiempo restante para completar el pago:</strong>
            <span id="tiempo-restante" class="fw-bold"></span>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row">
        <!-- Resumen de la transacción -->
        <div class="col-lg-4">
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Resumen de Pago</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <strong>Tipo de operación:</strong><br>
                {{ transaccion.tipo_operacion.nombre }}
              </div>
              
              <div class="mb-3">
                <strong>Moneda:</strong><br>
                {% if transaccion.tipo_operacion.codigo == 'VENTA' %}
                  {{ transaccion.moneda_origen.nombre }} ({{ transaccion.moneda_origen.codigo }})
                {% else %}
                  {{ transaccion.moneda_destino.nombre }} ({{ transaccion.moneda_destino.codigo }})
                {% endif %}
              </div>

              <div class="mb-3">
                <strong>Monto a pagar:</strong><br>
                <span class="h5 text-primary">
                  {% if transaccion.tipo_operacion.codigo == 'VENTA' %}
                    {{ transaccion.monto_destino|moneda_format:transaccion.moneda_destino.codigo }}
                  {% else %}
                    {{ transaccion.monto_origen|moneda_format:transaccion.moneda_origen.codigo }}
                  {% endif %}
                </span>
              </div>

              <div class="mb-3">
                <strong>Método de cobro:</strong><br>
                {{ transaccion.metodo_cobro.nombre }}
              </div>

            </div>
          </div>
        </div>

        <!-- Datos de cuenta bancaria -->
        <div class="col-lg-4">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-university me-2"></i>
                Datos para Transferencia
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <strong>Banco:</strong><br>
                {{ datos_cuenta.banco }}
              </div>
              
              <div class="mb-3">
                <strong>Titular de la cuenta:</strong><br>
                {{ datos_cuenta.titular }}
              </div>
              
              <div class="mb-3">
                <strong>RUC:</strong><br>
                <span class="font-monospace">{{ datos_cuenta.ruc }}</span>
              </div>
              
              <div class="mb-3">
                <strong>Número de cuenta:</strong><br>
                <span class="font-monospace h6">{{ datos_cuenta.numero_cuenta }}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copiarTexto('{{ datos_cuenta.numero_cuenta }}')">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
              
              <div class="mb-3">
                <strong>Tipo de cuenta:</strong><br>
                {{ datos_cuenta.tipo_cuenta }}
              </div>
                     
              <div class="mb-0">
                <strong>Código SWIFT:</strong><br>
                <span class="font-monospace">{{ datos_cuenta.codigo_swift }}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copiarTexto('{{ datos_cuenta.codigo_swift }}')">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Instrucciones:</strong><br>
            1. Realice la transferencia a la cuenta mostrada<br>
            2. Use el ID de transacción como referencia<br>
            3. Complete el formulario con los datos del comprobante
          </div>
        </div>

        <!-- Formulario de comprobante -->
        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Comprobante de Pago
              </h5>
            </div>
            <div class="card-body">
              <form method="post" id="form-pago">
                {% csrf_token %}
                
                <div class="mb-3">
                  <label for="{{ form.numero_comprobante.id_for_label }}" class="form-label">
                    {{ form.numero_comprobante.label }}
                    <span class="text-danger">*</span>
                  </label>
                  {{ form.numero_comprobante }}
                  {% if form.numero_comprobante.help_text %}
                    <div class="form-text">{{ form.numero_comprobante.help_text }}</div>
                  {% endif %}
                  {% if form.numero_comprobante.errors %}
                    <div class="text-danger">
                      {% for error in form.numero_comprobante.errors %}
                        <small>{{ error }}</small>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <label for="{{ form.banco_origen.id_for_label }}" class="form-label">
                    {{ form.banco_origen.label }}
                    <span class="text-danger">*</span>
                  </label>
                  {{ form.banco_origen }}
                  {% if form.banco_origen.help_text %}
                    <div class="form-text">{{ form.banco_origen.help_text }}</div>
                  {% endif %}
                  {% if form.banco_origen.errors %}
                    <div class="text-danger">
                      {% for error in form.banco_origen.errors %}
                        <small>{{ error }}</small>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="mb-3">
                  <label for="{{ form.fecha_transferencia.id_for_label }}" class="form-label">
                    {{ form.fecha_transferencia.label }}
                    <span class="text-danger">*</span>
                  </label>
                  {{ form.fecha_transferencia }}
                  {% if form.fecha_transferencia.help_text %}
                    <div class="form-text">{{ form.fecha_transferencia.help_text }}</div>
                  {% endif %}
                  {% if form.fecha_transferencia.errors %}
                    <div class="text-danger">
                      {% for error in form.fecha_transferencia.errors %}
                        <small>{{ error }}</small>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="mb-4">
                  <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                    {{ form.observaciones.label }}
                  </label>
                  {{ form.observaciones }}
                  {% if form.observaciones.help_text %}
                    <div class="form-text">{{ form.observaciones.help_text }}</div>
                  {% endif %}
                  {% if form.observaciones.errors %}
                    <div class="text-danger">
                      {% for error in form.observaciones.errors %}
                        <small>{{ error }}</small>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success btn-lg" id="btn-confirmar-pago">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Transferencia
                  </button>
                  <a href="{% url 'transacciones:resumen_transaccion' transaccion.id_transaccion %}" 
                     class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver al Resumen
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Temporizador
    const alertElement = document.getElementById('temporizador-alert');
    if (alertElement) {
        const tiempoRestante = parseInt(alertElement.dataset.tiempoRestante) || 0;
        if (tiempoRestante > 0) {
            iniciarTemporizador(tiempoRestante);
        }
    }

    // Establecer fecha de hoy por defecto
    const fechaInput = document.getElementById('{{ form.fecha_transferencia.id_for_label }}');
    if (fechaInput && !fechaInput.value) {
        const hoy = new Date().toISOString().split('T')[0];
        fechaInput.value = hoy;
    }

    // Confirmación antes de enviar
    const form = document.getElementById('form-pago');
    form.addEventListener('submit', function(e) {
        const confirmacion = confirm('¿Confirma que ha realizado la transferencia bancaria y los datos del comprobante son correctos?');
        if (!confirmacion) {
            e.preventDefault();
        }
    });
});

function copiarTexto(texto) {
    navigator.clipboard.writeText(texto).then(function() {
        // Mostrar feedback visual
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function() {
        alert('No se pudo copiar el texto. Por favor, cópielo manualmente.');
    });
}

function iniciarTemporizador(segundos) {
    const elemento = document.getElementById('tiempo-restante');
    const alert = document.getElementById('temporizador-alert');
    
    function formatearTiempo(segundos) {
        const minutos = Math.floor(segundos / 60);
        const segs = Math.floor(segundos % 60);
        return `${minutos}:${segs.toString().padStart(2, '0')}`;
    }
    
    function actualizarTemporizador() {
        if (segundos <= 0) {
            alert.className = 'alert alert-danger';
            elemento.textContent = '¡Tiempo expirado!';
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            return;
        }
        
        elemento.textContent = formatearTiempo(segundos);
        
        if (segundos <= 300) { // 5 minutos
            alert.className = 'alert alert-danger';
        } else if (segundos <= 600) { // 10 minutos
            alert.className = 'alert alert-warning';
        }
        
        segundos--;
        setTimeout(actualizarTemporizador, 1000);
    }
    
    actualizarTemporizador();
}
</script>
{% endblock %}